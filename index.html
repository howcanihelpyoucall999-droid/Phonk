<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zag Messenger — With Groups</title>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#e9f1ff;
      --primary:#0b60d6;
      --primary-dark:#0849a6;
      --muted:#9aaecf;
      --hand-font:'Patrick Hand', 'Segoe UI', Arial, sans-serif;
    }
    /* Use bg.png as background. Put bg.png in the same folder as this HTML file. */
    html,body{
      height:100%;
      margin:0;
      font-family:var(--hand-font);
      /* gradient overlay on top of the background image for a soft look */
      background:
        linear-gradient(180deg, rgba(233,241,255,0.85), rgba(238,246,255,0.85) 60%),
        url('bg.png') center/cover no-repeat;
      overflow:hidden;
      background-color: var(--bg); /* fallback color */
    }
    .phone{width:100%;height:100vh;background:rgba(255,255,255,0.9);display:flex;flex-direction:column;box-sizing:border-box;}
    .header{display:flex;align-items:center;padding:10px 14px;gap:10px;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;}
    .logo{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);background:linear-gradient(180deg,#fff,#f7fbff);}
    .title{font-size:20px;color:#fff;font-weight:700;}
    .menu{margin-left:auto;font-size:20px;color:#fff;}
    .wave-top svg{width:100%;height:100%;display:block;}
    .wave-top path{fill:var(--primary-dark);}
    .wave-top{width:100%;height:28px;}
    .auth{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:20px;overflow-y:auto;background:#f0f4fc;}
    .welcome{font-size:22px;color:var(--primary);}
    .sub{color:var(--muted);font-size:13px;margin-bottom:12px;}
    input{border:1px solid rgba(75,134,230,0.08);border-radius:10px;padding:12px 14px;font-size:15px;background:linear-gradient(180deg,#fff,#fbfdff);font-family:var(--hand-font);color:var(--primary);width:90%;max-width:360px;margin-bottom:10px;box-sizing:border-box;}
    .phone-group{display:flex;align-items:center;gap:8px;width:90%;max-width:360px;margin-bottom:10px;}
    .country-code{border:1px solid rgba(75,134,230,0.08);border-radius:10px;padding:12px;width:70px;text-align:center;background:linear-gradient(180deg,#fff,#fbfdff);color:var(--primary);}
    .btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;font-size:15px;box-shadow:0 6px 14px rgba(75,134,230,0.08);width:90%;max-width:360px;margin-bottom:8px;font-family:var(--hand-font);}
    .primary{background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;}
    .ghost{background:#f6f9ff;color:var(--primary);}
    .toggle-btns{display:flex;gap:12px;margin-top:12px;flex-direction:column;align-items:center;} /* Adjusted for better layout */
    .toggle-btns .btn{width:auto;padding:8px 16px;}
    .app{display:none;flex:1;overflow-y:auto;padding:16px 18px 120px 18px;box-sizing:border-box;}
    .top-controls{display:flex;align-items:center;gap:12px;margin-bottom:8px;justify-content:space-between;}
    .chats h3{color:var(--primary);margin:8px 0 12px;}
    .chat-item{display:flex;gap:10px;align-items:center;padding:12px;background:linear-gradient(180deg,#fff,#fbfdff);border-radius:10px;margin-bottom:12px;border:1px solid rgba(75,134,230,0.06);cursor:pointer;}
    .avatar{width:52px;height:52px;border-radius:50%;background:linear-gradient(180deg,#dbeeff,#c1ddff);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);font-size:18px;}
    .chat-meta{flex:1;}
    .chat-meta .name{font-weight:700;color:var(--primary);font-size:16px;}
    .chat-meta .sub{font-size:13px;color:var(--muted);margin-top:4px;}
    #add-chat-area{display:none;margin-bottom:12px;position:relative;}
    #closeAddChat{position:absolute;top:-10px;right:-10px;background:#fff;border:2px solid #ccc;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold;color:#777;}
    .floating-new{position:fixed;right:18px;bottom:96px;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 12px 28px rgba(11,96,214,0.2);border:4px solid #fff;font-weight:700;cursor:pointer;z-index:40;}
    .bottom-nav{position:fixed;left:0;bottom:0;width:100%;background:linear-gradient(180deg,#fff,#f6fbff);border-top:1px solid rgba(0,0,0,0.03);padding:14px;text-align:center;color:var(--primary);font-size:18px;font-weight:700;z-index:45;display:flex;gap:10px;justify-content:center;align-items:center;}
    .bottom-nav span{cursor:pointer;padding:6px 10px;border-radius:8px;}
    .bottom-nav .active{background:linear-gradient(180deg,#eff7ff,#dfeffe);box-shadow:0 6px 14px rgba(11,96,214,0.06);}
    /* chat screen */
    .chat-screen{display:none;flex-direction:column;flex:1;overflow:hidden;padding:8px 18px 0 18px;box-sizing:border-box;}
    .chat-header{display:flex;gap:10px;align-items:center;padding:8px 6px;border-bottom:1px dashed rgba(75,134,230,0.04);margin-bottom:8px;}
    #backToChatListBtn{padding:4px 8px !important;border-radius:6px !important;font-size:13px !important;}
    #current-chat-avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(180deg,#dbeeff,#c1ddff);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);font-size:16px;flex-shrink:0;}
    .chat-messages{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px;padding:6px;padding-bottom:20px;box-sizing:border-box;}
    .bubble{padding:10px 14px;border-radius:18px;max-width:78%;line-height:1.4;box-shadow:0 6px 14px rgba(10,30,80,0.04);}
    .bubble.sent{align-self:flex-end;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;}
    .bubble.received{align-self:flex-start;background:#fff;color:var(--primary);border:1px solid rgba(75,134,230,0.04);}
    /* Message Input Area */
    .chat-input-area-wrapper{margin-top:auto;flex-shrink:0;padding:8px 18px 10px 18px;background:#fff;box-sizing:border-box;width:100%;z-index:49;border-top:1px solid rgba(11,96,214,0.08);}
    .chat-input{display:flex;gap:8px;align-items:center;border-radius:999px;padding:8px;background:#fff;border:2px solid var(--primary);transition:border-color 0.3s, transform 0.1s;}
    @keyframes gentleShake{0%,100%{transform:translateX(0);}25%{transform:translateX(-2px);}75%{transform:translateX(2px);}}
    .chat-input.typing{animation:gentleShake 0.25s ease-in-out;}
    .chat-input input{flex:1;border:none;outline:none;font-size:15px;padding:10px 6px;font-family:var(--hand-font);color:var(--primary);background:transparent;}
    .send-btn{width:44px;height:44px;border-radius:50%;border:none;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;box-shadow:0 4px 10px rgba(11,96,214,0.15);}
    /* Group modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:60;}
    .modal{width:92%;max-width:520px;background:#fff;border-radius:12px;padding:16px;box-sizing:border-box;box-shadow:0 20px 60px rgba(0,0,0,0.12);}
    .modal h4{margin:0 0 8px 0;color:var(--primary);}
    .contacts-list{max-height:180px;overflow:auto;border:1px dashed rgba(75,134,230,0.06);padding:8px;border-radius:8px;margin-top:8px;}
    .contact-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;cursor:pointer;}
    .small{font-size:13px;color:var(--muted);}
    .section-title{font-size:13px;color:var(--muted);margin-top:8px;margin-bottom:6px;}
    /* responsive tweaks */
    @media (min-width:900px){
      .phone{max-width:420px;margin:0 auto;box-shadow:0 20px 60px rgba(0,0,0,0.08);}
    }
  </style>
</head>
<body>
  <div class="phone">
    <div class="header">
      <div class="logo">Zg</div>
      <div class="title">Zag Messenger</div>
      <div class="menu">☰</div>
    </div>

    <div class="wave-top">
      <svg viewBox="0 0 100 10" preserveAspectRatio="none"><path d="M0 5 C20 9,40 1,60 5 C80 9,100 3,100 3 L100 10 L0 10 Z"></path></svg>
    </div>

    <!-- Auth -->
    <div class="auth" id="auth-section">
      <div class="welcome">Welcome,<br>to Zag Messenger.</div>
      <div class="sub">Write your World</div>
      <input id="email" type="email" placeholder="Email">
      <div class="phone-group">
        <input class="country-code" value="+880" disabled>
        <input id="phoneNumber" type="tel" placeholder="Phone number">
      </div>
      <input id="password" type="password" placeholder="Password">

      <button id="authSubmitBtn" class="btn primary">Sign Up</button>

      <div class="toggle-btns">
        <button id="toSignIn" class="btn ghost">Already have an account? Sign In</button>
        <button id="toSignUp" class="btn ghost" style="display:none;">Don't have an account? Sign Up</button>
      </div>
    </div>

    <!-- App (Chats & Groups) -->
    <div class="app" id="app-section">
      <div class="top-controls">
        <h3 style="margin:0" id="list-title">My chats</h3>
        <div style="display:flex;gap:8px;align-items:center;">
          <div style="font-size:14px;color:var(--muted);">Switch</div>
          <!-- floatingNew will act as add for both -->
        </div>
      </div>

      <!-- Add (for Individual & Group) -->
      <div id="add-chat-area">
        <div id="closeAddChat">×</div>
        <input id="addChatIdentifier" type="text" placeholder="Enter user email or phone">
        <button id="addChatBtn" class="btn primary">Add Person</button>
      </div>

      <!-- Lists -->
      <div id="chat-list-container"></div>
      <div id="group-list-container" style="display:none;"></div>
    </div>

    <!-- Chat Screen -->
    <div class="chat-screen" id="individual-chat-container">
      <div class="chat-header">
        <button id="backToChatListBtn" class="btn ghost">&lt; Back</button>
        <div id="current-chat-avatar" class="avatar"></div>
        <div>
          <div id="current-chat-name" style="font-weight:700;color:var(--primary);"></div>
          <div id="current-chat-sub" style="font-size:12px;color:var(--muted)"></div>
        </div>
      </div>
      <div id="chat-messages" class="chat-messages"></div>

      <div class="chat-input-area-wrapper">
        <div id="chat-input-area" class="chat-input">
          <input id="chatMessageInput" type="text" placeholder="Type a message...">
          <button id="sendChatMessageBtn" class="send-btn">➤</button>
        </div>
      </div>
    </div>

    <div class="bottom-nav" id="bottom-nav">
      <span id="nav-home" class="active">Home</span>
      <span id="nav-groups">Groups</span>
      <span id="nav-games">Games</span>
      <span id="nav-you">@You</span>
    </div>

    <div class="floating-new" id="floatingNewBtn" title="Add new" style="display:none;">+</div>
  </div>

  <!-- Group Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h4 id="modalTitle">New Group</h4>
      <div class="section-title">Group name</div>
      <input id="groupName" placeholder="Type group name..." />

      <div class="section-title">Add people (type email or phone and press Enter)</div>
      <input id="addMemberInput" placeholder="Email or phone" />

      <div class="section-title">Selected members</div>
      <div id="selectedMembers" style="min-height:40px;margin-bottom:8px;"></div>

      <div class="section-title">Contacts (tap to toggle)</div>
      <div class="contacts-list" id="contactsList"></div>

      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button id="cancelCreateGroup" class="btn ghost" style="width:auto;padding:8px 12px;">Cancel</button>
        <button id="createGroupBtn" class="btn primary" style="width:auto;padding:8px 12px;">Create Group</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase imports
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js';
    import { getDatabase, ref as dbRef, set, get, push, onValue, onChildAdded, update } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyBUH95hXYxMVCfhJglN4j3CReXy-CLYwmA',
      authDomain: 'live-messageinggkkh.firebaseapp.com',
      databaseURL: 'https://live-messageinggkkh-default-rtdb.firebaseio.com',
      projectId: 'live-messageinggkkh',
      storageBucket: 'live-messageinggkkh.appspot.com',
      messagingSenderId: '537475612761',
      appId: '1:537475612761:web:d00723c117383e54027148'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // DOM refs
    const authSection = document.getElementById('auth-section');
    const appSection = document.getElementById('app-section');
    const individualChat = document.getElementById('individual-chat-container');
    const floatingBtn = document.getElementById('floatingNewBtn');
    const addChatArea = document.getElementById('add-chat-area');
    const addBtn = document.getElementById('addChatBtn');
    const closeAdd = document.getElementById('closeAddChat');
    const chatList = document.getElementById('chat-list-container');
    const groupList = document.getElementById('group-list-container');
    const backBtn = document.getElementById('backToChatListBtn');
    const sendBtn = document.getElementById('sendChatMessageBtn');
    const msgInput = document.getElementById('chatMessageInput');
    const msgContainer = document.getElementById('chat-messages');
    const bottomNav = document.getElementById('bottom-nav');
    const authSubmitBtn = document.getElementById('authSubmitBtn'); // Renamed from loginBtn
    const email = document.getElementById('email');
    const pass = document.getElementById('password');
    const phone = document.getElementById('phoneNumber');
    const toSignIn = document.getElementById('toSignIn');
    const toSignUp = document.getElementById('toSignUp');
    const navHome = document.getElementById('nav-home');
    const navGroups = document.getElementById('nav-groups');
    const navGames = document.getElementById('nav-games');
    const navYou = document.getElementById('nav-you');
    const listTitle = document.getElementById('list-title');
    const welcomeText = document.querySelector('.welcome'); // Added for dynamic text

    // Modal refs
    const modalBackdrop = document.getElementById('modalBackdrop');
    const createGroupBtn = document.getElementById('createGroupBtn');
    const cancelCreateGroup = document.getElementById('cancelCreateGroup');
    const groupNameInput = document.getElementById('groupName');
    const addMemberInput = document.getElementById('addMemberInput');
    const selectedMembersDiv = document.getElementById('selectedMembers');
    const contactsListDiv = document.getElementById('contactsList');

    // state
    let currentChat = null; // { type: 'private'|'group', id: string }
    let currentUser = null;
    let usersCache = {}; // uid -> {email, phoneNumber, uid}
    let selectedGroupMembers = {}; // uid -> user object

    let isSigningUp = true; // State to track if we're in sign-up or sign-in mode

    // UI toggles for auth
    function updateAuthUI() {
      if (isSigningUp) {
        authSubmitBtn.textContent = 'Sign Up';
        welcomeText.innerHTML = 'Welcome,<br>to Zag Messenger.';
        phone.parentElement.style.display = 'flex'; // Show phone for sign up (parent div)
        toSignIn.style.display = 'block';
        toSignUp.style.display = 'none';
        authSubmitBtn.classList.add('primary');
        authSubmitBtn.classList.remove('ghost');
      } else {
        authSubmitBtn.textContent = 'Sign In';
        welcomeText.innerHTML = 'Welcome Back,<br>to Zag Messenger.';
        phone.parentElement.style.display = 'none'; // Hide phone for sign in (parent div)
        toSignIn.style.display = 'none';
        toSignUp.style.display = 'block';
        authSubmitBtn.classList.add('primary');
        authSubmitBtn.classList.remove('ghost');
      }
    }

    toSignIn.addEventListener('click', () => {
      isSigningUp = false;
      updateAuthUI();
    });

    toSignUp.addEventListener('click', () => {
      isSigningUp = true;
      updateAuthUI();
    });

    // Initial UI setup
    updateAuthUI();

    // Auth create profile helper
    async function createUserProfile(user) {
      if (!user) return;
      const userRef = dbRef(db, 'users/' + user.uid);
      const snap = await get(userRef);
      if (!snap.exists()) {
        await set(userRef, {
          email: user.email || '',
          uid: user.uid,
          phoneNumber: '+880' + (phone.value.trim() || '')
        });
      }
    }

    // Combined Sign up / Sign in button logic
    authSubmitBtn.addEventListener('click', async () => {
      const e = email.value.trim();
      const p = pass.value.trim();
      const ph = phone.value.trim();

      if (!e || !p) {
        return alert('Please enter email and password.');
      }

      if (isSigningUp && !ph) {
        return alert('Please enter your phone number for sign up.');
      }

      try {
        if (isSigningUp) {
          const res = await createUserWithEmailAndPassword(auth, e, p);
          await createUserProfile(res.user);
          alert('Sign up successful!');
        } else {
          await signInWithEmailAndPassword(auth, e, p);
          alert('Sign in successful!');
        }
      } catch (err) {
        alert(`${isSigningUp ? 'Sign up' : 'Sign in'} failed: ` + err.message);
      }
    });

    // --- ADDED: Support legacy separate signup/login buttons (if present in other versions)
    const signupBtnLegacy = document.getElementById('signupBtn');
    const loginBtnLegacy = document.getElementById('loginBtn');
    if (signupBtnLegacy) {
      signupBtnLegacy.addEventListener('click', () => {
        isSigningUp = true;
        updateAuthUI();
        // trigger the main authSubmitBtn logic
        authSubmitBtn.click();
      });
    }
    if (loginBtnLegacy) {
      loginBtnLegacy.addEventListener('click', () => {
        isSigningUp = false;
        updateAuthUI();
        authSubmitBtn.click();
      });
    }
    // --- END ADDED

    // Auth state
    onAuthStateChanged(auth, user => {
      currentUser = user;
      updateUI(user);
      if (user) loadUsersCache();
    });

    function updateUI(user) {
      if (user) {
        authSection.style.display = 'none';
        appSection.style.display = 'block';
        individualChat.style.display = 'none';
        floatingBtn.style.display = 'flex';
        bottomNav.style.display = 'flex';
        navHome.classList.add('active');
        navGroups.classList.remove('active');
        listTitle.innerText = 'My chats';
        loadChats();
        loadGroups();
      } else {
        authSection.style.display = 'flex';
        appSection.style.display = 'none';
        individualChat.style.display = 'none';
        floatingBtn.style.display = 'none';
        bottomNav.style.display = 'flex';
        navHome.classList.remove('active');
        navGroups.classList.remove('active');
      }
    }

    // Load all user profiles (cache) to use for group creation contact list
    function loadUsersCache() {
      onValue(dbRef(db, 'users'), snap => {
        usersCache = {};
        contactsListDiv.innerHTML = '';
        snap.forEach(s => {
          const u = s.val();
          if (!u || !u.uid) return;
          usersCache[u.uid] = u;
          // show contact item (exclude current user)
          if (currentUser && u.uid !== currentUser.uid) {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.dataset.uid = u.uid;
            div.innerHTML = `<div class="avatar" style="width:36px;height:36px;font-size:14px;border-radius:6px">${(u.email || 'U').charAt(0).toUpperCase()}</div>
                             <div style="flex:1;">
                               <div style="font-weight:700;color:var(--primary);font-size:14px">${(u.email || 'Unknown').split('@')[0]}</div>
                               <div class="small">${u.email || u.phoneNumber || ''}</div>
                             </div>`;
            // toggle selection
            div.addEventListener('click', () => {
              const uid = div.dataset.uid;
              if (selectedGroupMembers[uid]) {
                delete selectedGroupMembers[uid];
                div.style.opacity = '1';
              } else {
                selectedGroupMembers[uid] = u;
                div.style.opacity = '0.6';
              }
              renderSelectedMembers();
            });
            contactsListDiv.appendChild(div);
          }
        });
      });
    }

    function renderSelectedMembers() {
      selectedMembersDiv.innerHTML = '';
      Object.values(selectedGroupMembers).forEach(u => {
        const span = document.createElement('span');
        span.style.display = 'inline-block';
        span.style.padding = '6px 8px';
        span.style.margin = '4px';
        span.style.borderRadius = '8px';
        span.style.background = '#f6f9ff';
        span.style.color = 'var(--primary)';
        span.textContent = (u.email || u.phoneNumber || 'user').split('@')[0];
        selectedMembersDiv.appendChild(span);
      });
    }

    function loadChats() {
      chatList.innerHTML = '';
      const ref = dbRef(db, 'chats');
      onValue(ref, snap => {
        chatList.innerHTML = '';
        snap.forEach(s => {
          const c = s.val();
          // show all chats involving current user (if members array exists)
          const members = c.members || [];
          if (!currentUser || !members.includes(currentUser.uid)) return;
          const otherId = members.find(m => m !== currentUser.uid) || members[0];
          const name = (c.name || otherId);
          const div = document.createElement('div');
          div.className = 'chat-item';
          div.innerHTML = `<div class="avatar" style="width:44px;height:44px;border-radius:10px">${(name || 'U').charAt(0).toUpperCase()}</div>
            <div style="flex:1">
              <div style="font-weight:700;color:var(--primary);">${name}</div>
              <div class="small">${c.lastMessage || ''}</div>
            </div>`;
          div.addEventListener('click', () => openChat(s.key, c));
          chatList.appendChild(div);
        });
        if (!chatList.hasChildNodes()) {
          chatList.innerHTML = '<div style="color:#999;text-align:center;padding:12px">No chats yet</div>';
        }
      });
    }

    function loadGroups() {
      // simple group loading — similar to chats
      groupList.innerHTML = '';
      const ref = dbRef(db, 'groups');
      onValue(ref, snap => {
        groupList.innerHTML = '';
        snap.forEach(s => {
          const g = s.val();
          const div = document.createElement('div');
          div.className = 'chat-item';
          div.innerHTML = `<div class="avatar" style="width:44px;height:44px;border-radius:10px">${(g.name || 'G').charAt(0).toUpperCase()}</div>
            <div style="flex:1">
              <div style="font-weight:700;color:var(--primary);">${g.name || 'Group'}</div>
              <div class="small">${(g.members && Object.keys(g.members).length) || 0} members</div>
            </div>`;
          div.addEventListener('click', () => openGroup(s.key, g));
          groupList.appendChild(div);
        });
      });
    }

    function openChat(id, data) {
      currentChat = { type: 'private', id };
      appSection.style.display = 'none';
      individualChat.style.display = 'flex';
      document.getElementById('current-chat-name').textContent = data.name || 'Chat';
      document.getElementById('current-chat-avatar').textContent = (data.name || 'U').charAt(0).toUpperCase();
      // listen to messages
      const msgRef = dbRef(db, `messages/${id}`);
      onValue(msgRef, snap => {
        msgContainer.innerHTML = '';
        snap.forEach(m => {
          const mv = m.val();
          const b = document.createElement('div');
          b.className = 'bubble ' + (mv.from === currentUser.uid ? 'sent' : 'received');
          b.textContent = mv.text || '';
          msgContainer.appendChild(b);
        });
        msgContainer.scrollTop = msgContainer.scrollHeight;
      });
    }

    function openGroup(id, data) {
      currentChat = { type: 'group', id };
      appSection.style.display = 'none';
      individualChat.style.display = 'flex';
      document.getElementById('current-chat-name').textContent = data.name || 'Group';
      document.getElementById('current-chat-avatar').textContent = (data.name || 'G').charAt(0).toUpperCase();
      const msgRef = dbRef(db, `groupMessages/${id}`);
      onValue(msgRef, snap => {
        msgContainer.innerHTML = '';
        snap.forEach(m => {
          const mv = m.val();
          const b = document.createElement('div');
          b.className = 'bubble ' + (mv.from === currentUser.uid ? 'sent' : 'received');
          b.textContent = mv.text || '';
          msgContainer.appendChild(b);
        });
        msgContainer.scrollTop = msgContainer.scrollHeight;
      });
    }

    // Add new chat button toggle
    floatingBtn.addEventListener('click', () => {
      if (addChatArea.style.display === 'none' || addChatArea.style.display === '') {
        addChatArea.style.display = 'block';
      } else {
        addChatArea.style.display = 'none';
      }
    });

    closeAdd.addEventListener('click', () => {
      addChatArea.style.display = 'none';
    });

    addBtn.addEventListener('click', async () => {
      const id = document.getElementById('addChatIdentifier').value.trim();
      if (!id) return alert('Enter email or phone to add.');
      // simplistic: create chat node
      const newChatRef = push(dbRef(db, 'chats'));
      await set(newChatRef, {
        name: id,
        members: currentUser ? [currentUser.uid] : [],
        lastMessage: ''
      });
      addChatArea.style.display = 'none';
      document.getElementById('addChatIdentifier').value = '';
    });

    // send message
    sendBtn.addEventListener('click', async () => {
      const text = msgInput.value.trim();
      if (!text || !currentChat) return;
      const refPath = currentChat.type === 'private' ? `messages/${currentChat.id}` : `groupMessages/${currentChat.id}`;
      const newMsgRef = push(dbRef(db, refPath));
      await set(newMsgRef, { text, from: currentUser.uid, ts: Date.now() });
      msgInput.value = '';
      // update last message in chat/group
      if (currentChat.type === 'private') {
        update(dbRef(db, `chats/${currentChat.id}`), { lastMessage: text });
      } else {
        update(dbRef(db, `groups/${currentChat.id}`), { lastMessage: text });
      }
    });

    // back button
    backBtn.addEventListener('click', () => {
      individualChat.style.display = 'none';
      appSection.style.display = 'block';
    });

    // Group modal logic
    document.getElementById('floatingNewBtn').addEventListener('click', () => {
      modalBackdrop.style.display = 'flex';
    });
    cancelCreateGroup.addEventListener('click', () => {
      modalBackdrop.style.display = 'none';
    });

    addMemberInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const v = addMemberInput.value.trim();
        if (!v) return;
        // add to selectedMembersDiv as a badge
        const uid = 'temp:' + v;
        selectedGroupMembers[uid] = { email: v };
        renderSelectedMembers();
        addMemberInput.value = '';
      }
    });

    createGroupBtn.addEventListener('click', async () => {
      const name = groupNameInput.value.trim();
      if (!name) return alert('Enter group name');
      const gRef = push(dbRef(db, 'groups'));
      const membersObj = {};
      Object.values(selectedGroupMembers).forEach((u, i) => {
        membersObj[(u.uid || ('m'+i))] = u.email || u.phoneNumber || ('m'+i);
      });
      await set(gRef, { name, members: membersObj, createdAt: Date.now() });
      modalBackdrop.style.display = 'none';
      groupNameInput.value = '';
      selectedGroupMembers = {};
      renderSelectedMembers();
    });

    // Load contacts into modal when opening
    function openGroupModal() {
      contactsListDiv.innerHTML = '';
      // usersCache will be filled by loadUsersCache
      Object.values(usersCache).forEach(u => {
        const div = document.createElement('div');
        div.className = 'contact-item';
        div.dataset.uid = u.uid;
        div.innerHTML = `<div class="avatar" style="width:36px;height:36px;font-size:14px;border-radius:6px">${(u.email || 'U').charAt(0).toUpperCase()}</div>
                         <div style="flex:1;">
                           <div style="font-weight:700;color:var(--primary);font-size:14px">${(u.email || 'Unknown').split('@')[0]}</div>
                           <div class="small">${u.email || u.phoneNumber || ''}</div>
                         </div>`;
        div.addEventListener('click', () => {
          const uid = div.dataset.uid;
          if (selectedGroupMembers[uid]) {
            delete selectedGroupMembers[uid];
            div.style.opacity = '1';
          } else {
            selectedGroupMembers[uid] = u;
            div.style.opacity = '0.6';
          }
          renderSelectedMembers();
        });
        contactsListDiv.appendChild(div);
      });
    }

    // ensure modal opens contacts when displayed
    modalBackdrop.addEventListener('transitionend', () => {
      if (modalBackdrop.style.display === 'flex') openGroupModal();
    });

    // --- END of main app logic ---

  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>Zag Messenger — With Groups (improved input & group options)</title>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#e9f1ff;
      --primary:#0b60d6;
      --primary-dark:#0849a6;
      --muted:#9aaecf;
      --hand-font:'Patrick Hand', 'Segoe UI', Arial, sans-serif;
    }
    html,body{height:100%;margin:0;font-family:var(--hand-font);background:linear-gradient(180deg,var(--bg),#eef6ff 60%);-webkit-font-smoothing:antialiased;overflow:hidden;}
    .phone{width:100%;height:100vh;background:#fff;display:flex;flex-direction:column;box-sizing:border-box;position:relative;}
    .header{display:flex;align-items:center;padding:10px 14px;gap:10px;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;Position:relative;z-index:60;}
    .logo{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);background:linear-gradient(180deg,#fff,#f7fbff);}
    .title{font-size:20px;color:#fff;font-weight:700;}
    .menu{margin-left:auto;font-size:20px;color:#fff;}
    .wave-top svg{width:100%;height:100%;display:block;}
    .wave-top path{fill:var(--primary-dark);}
    .wave-top{width:100%;height:28px;position:relative;z-index:55;}
    .auth{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:20px;overflow-y:auto;background:#f0f4fc;}
    .welcome{font-size:22px;color:var(--primary);}
    .sub{color:var(--muted);font-size:13px;margin-bottom:12px;}
    input{border:1px solid rgba(75,134,230,0.08);border-radius:10px;padding:12px 14px;font-size:15px;background:linear-gradient(180deg,#fff,#fbfdff);font-family:var(--hand-font);color:var(--primary);width:90%;max-width:360px;margin-bottom:10px;box-sizing:border-box;}
    .phone-group{display:flex;align-items:center;gap:8px;width:90%;max-width:360px;margin-bottom:10px;}
    .country-code{border:1px solid rgba(75,134,230,0.08);border-radius:10px;padding:12px;width:70px;text-align:center;background:linear-gradient(180deg,#fff,#fbfdff);color:var(--primary);}
    .btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;font-size:15px;box-shadow:0 6px 14px rgba(75,134,230,0.08);width:90%;max-width:360px;margin-bottom:8px;font-family:var(--hand-font);}
    .primary{background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;}
    .ghost{background:#f6f9ff;color:var(--primary);}
    .toggle-btns{display:flex;gap:12px;margin-top:12px;flex-direction:column;align-items:center;}
    .toggle-btns .btn{width:auto;padding:8px 16px;}
    .app{display:none;flex:1;overflow-y:auto;padding:16px 18px 120px 18px;box-sizing:border-box;}
    .top-controls{display:flex;align-items:center;gap:12px;margin-bottom:8px;justify-content:space-between;}
    .chats h3{color:var(--primary);margin:8px 0 12px;}
    .chat-item{display:flex;gap:10px;align-items:center;padding:12px;background:linear-gradient(180deg,#fff,#fbfdff);border-radius:10px;margin-bottom:12px;border:1px solid rgba(75,134,230,0.06);cursor:pointer;}
    .avatar{width:52px;height:52px;border-radius:50%;background:linear-gradient(180deg,#dbeeff,#c1ddff);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);font-size:18px;}
    .chat-meta{flex:1;}
    .chat-meta .name{font-weight:700;color:var(--primary);font-size:16px;}
    .chat-meta .sub{font-size:13px;color:var(--muted);margin-top:4px;}
    #add-chat-area{display:none;margin-bottom:12px;position:relative;}
    #closeAddChat{position:absolute;top:-10px;right:-10px;background:#fff;border:2px solid #ccc;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold;color:#777;}
    .floating-new{position:fixed;right:18px;bottom:96px;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 12px 28px rgba(11,96,214,0.2);border:4px solid #fff;font-weight:700;cursor:pointer;z-index:40;}
    .plus-menu{position:fixed;right:18px;bottom:160px;width:200px;background:#fff;border-radius:10px;padding:8px;box-shadow:0 20px 60px rgba(0,0,0,0.12);z-index:50;display:none;flex-direction:column;gap:8px;}
    .plus-menu button{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(11,96,214,0.06);background:#f6fbff;cursor:pointer;font-weight:700;color:var(--primary);}
    .bottom-nav{position:fixed;left:0;bottom:0;width:100%;background:linear-gradient(180deg,#fff,#f6fbff);border-top:1px solid rgba(0,0,0,0.03);padding:14px;text-align:center;color:var(--primary);font-size:18px;font-weight:700;z-index:45;display:flex;gap:10px;justify-content:center;align-items:center;}
    .bottom-nav span{cursor:pointer;padding:6px 10px;border-radius:8px;}
    .bottom-nav .active{background:linear-gradient(180deg,#eff7ff,#dfeffe);box-shadow:0 6px 14px rgba(11,96,214,0.06);}
    /* chat screen */
    .chat-screen{display:none;flex-direction:column;flex:1;overflow:hidden;padding:8px 18px 0 18px;box-sizing:border-box;}
    .chat-header{display:flex;gap:10px;align-items:center;padding:8px 6px;border-bottom:1px dashed rgba(75,134,230,0.04);margin-bottom:8px;z-index:10;position:relative;min-height:56px;}
    /* smaller back button */
    #backToChatListBtn{padding:6px 8px !important;border-radius:8px !important;font-size:13px !important;min-width:48px;display:inline-flex;align-items:center;justify-content:center;}
    #current-chat-avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(180deg,#dbeeff,#c1ddff);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);font-size:16px;flex-shrink:0;}
    /* center the name in the header */
    .centered-name{position:absolute;left:50%;transform:translateX(-50%);text-align:center;width:60%;pointer-events:none;}
    .centered-name .name{font-weight:700;color:var(--primary);font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .centered-name .sub{font-size:12px;color:var(--muted);opacity:0.9;}
    .three-dots{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:none;font-size:22px;color:var(--primary);cursor:pointer;padding:6px;border-radius:8px;}
    .chat-messages{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px;padding:6px;padding-bottom:160px;box-sizing:border-box;}
    .bubble{padding:10px 14px;border-radius:18px;max-width:78%;line-height:1.4;box-shadow:0 6px 14px rgba(10,30,80,0.04);}
    .bubble.sent{align-self:flex-end;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;}
    .bubble.received{align-self:flex-start;background:#fff;color:var(--primary);border:1px solid rgba(75,134,230,0.04);}
    .msg-meta{display:block;font-size:11px;opacity:0.85;margin-top:6px;}
    /* Message Input Area - smaller and fixed above bottom nav */
    .chat-input-area-wrapper{
      position:fixed;
      left:0;
      right:0;
      bottom:72px;
      padding:8px 18px 10px 18px;
      background:#fff;
      box-sizing:border-box;
      width:100%;
      z-index:80;
      display:flex;
      justify-content:center;
      -webkit-backdrop-filter: blur(4px);
      backdrop-filter: blur(4px);
      border-top:1px solid rgba(11,96,214,0.08);
      transition:bottom 0.18s ease, transform 0.18s ease;
    }
    .chat-input{display:flex;gap:8px;align-items:center;border-radius:999px;padding:6px 8px;background:#fff;border:2px solid var(--primary);transition:border-color 0.3s, transform 0.1s;max-width:920px;width:100%;box-sizing:border-box;height:56px;}
    .chat-input input{flex:1;border:none;outline:none;font-size:14px;padding:8px 6px;font-family:var(--hand-font);color:var(--primary);background:transparent;}
    .send-btn{width:44px;height:44px;border-radius:50%;border:none;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;box-shadow:0 4px 10px rgba(11,96,214,0.15);}
    /* Group options modal */
    .group-options-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:120;}
    .group-options{width:92%;max-width:420px;background:#fff;border-radius:12px;padding:16px;box-sizing:border-box;box-shadow:0 20px 60px rgba(0,0,0,0.12);overflow:auto;max-height:80vh;}
    .group-header{display:flex;align-items:center;gap:12px;margin-bottom:12px;}
    .group-photo{width:64px;height:64px;border-radius:50%;background:linear-gradient(180deg,#dbeeff,#c1ddff);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);font-size:20px;}
    .member-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid rgba(11,96,214,0.04);margin-bottom:8px;}
    .member-item .meta{flex:1;}
    .small{font-size:13px;color:var(--muted);}
    @media (min-width:900px){
      .phone{max-width:420px;margin:0 auto;box-shadow:0 20px 60px rgba(0,0,0,0.08);}
      .plus-menu{right:calc(50% - 210px);}
      .chat-input-area-wrapper{left:calc(50% - 210px);right:calc(50% - 210px);width:420px;bottom:72px;}
    }
  </style>

<!-- slide-in animation & top-banner hide (injected) -->
<style>
/* Keep these rules minimal to avoid changing layout */
.phone.hide-top .header,
.phone.hide-top .wave-top {
  transform: translateY(-12px);
  opacity: 0;
  pointer-events: none;
  transition: transform .32s ease, opacity .28s ease;
}

/* App area slides slightly left when chat opens */
#app-section.app-hidden {
  transform: translateX(-10%);
  opacity: 0.0;
  pointer-events: none;
  transition: transform .36s cubic-bezier(.2,.9,.34,1), opacity .28s ease;
}

/* Chat container initial state: offscreen to right */
#individual-chat-container.chat-off {
  transform: translateX(18%);
  opacity: 0;
  pointer-events: none;
  transition: transform .36s cubic-bezier(.2,.9,.34,1), opacity .28s ease;
}

/* Visible chat: slide to place */
#individual-chat-container.chat-on {
  transform: translateX(0%);
  opacity: 1;
  pointer-events: auto;
  transition: transform .42s cubic-bezier(.2,.9,.34,1), opacity .28s ease;
}

/* Ensure chat container displayed as flex when animating */
#individual-chat-container {
  display: none; /* kept default; JS will show when needed */
  will-change: transform, opacity;
}
</style>

</head>
<body>
  <div class="phone">
    <div class="header">
      <div class="logo">Zg</div>
      <div class="title">Zag Messenger</div>
      <div class="menu">☰</div>
    </div>

    <div class="wave-top" aria-hidden="true">
      <svg viewBox="0 0 100 10" preserveAspectRatio="none"><path d="M0 5 C20 9,40 1,60 5 C80 9,100 3,100 3 L100 10 L0 10 Z"></path></svg>
    </div>

    <div class="auth" id="auth-section">
      <div class="welcome">Welcome,<br>to Zag Messenger.</div>
      <div class="sub">Write your World</div>
      <input id="email" type="email" placeholder="Email">
      <div class="phone-group">
        <input class="country-code" value="+880" disabled>
        <input id="phoneNumber" type="tel" placeholder="Phone number">
      </div>
      <input id="password" type="password" placeholder="Password">

      <button id="authSubmitBtn" class="btn primary">Sign Up</button>

      <div class="toggle-btns">
        <button id="toSignIn" class="btn ghost">Already have an account? Sign In</button>
        <button id="toSignUp" class="btn ghost" style="display:none;">Don't have an account? Sign Up</button>
      </div>
    </div>

    <div class="app" id="app-section">
      <div class="top-controls">
        <h3 style="margin:0" id="list-title">My chats</h3>
        <div style="display:flex;gap:8px;align-items:center;">
          <div style="font-size:14px;color:var(--muted);">Switch</div>
        </div>
      </div>

      <div id="add-chat-area">
        <div id="closeAddChat">×</div>
        <input id="addChatIdentifier" type="text" placeholder="Enter user email or phone">
        <button id="addChatBtn" class="btn primary">Add Person</button>
      </div>

      <div id="chat-list-container"></div>
      <div id="group-list-container" style="display:none;"></div>
    </div>

    <div class="chat-screen" id="individual-chat-container" aria-live="polite">
      <div class="chat-header">
        <button id="backToChatListBtn" class="btn ghost">&lt; Back</button>
        <div id="current-chat-avatar" class="avatar"></div>

        <div class="centered-name">
          <div id="current-chat-name" class="name"></div>
          <div id="current-chat-sub" class="sub"></div>
        </div>

        <button id="groupOptionsBtn" class="three-dots" title="Options">⋮</button>
      </div>

      <div id="chat-messages" class="chat-messages"></div>

      <div class="chat-input-area-wrapper" aria-label="Message input area">
        <div id="chat-input-area" class="chat-input" role="form">
          <input id="chatMessageInput" type="text" placeholder="Type a message...">
          <button id="sendChatMessageBtn" class="send-btn" aria-label="Send message">➤</button>
        </div>
      </div>
    </div>

    <div class="bottom-nav" id="bottom-nav">
      <span id="nav-home" class="active">Home</span>
      <span id="nav-groups">Groups</span>
      <span id="nav-games">Games</span>
      <span id="nav-you">@You</span>
    </div>

    <div class="floating-new" id="floatingNewBtn" title="Add new" style="display:none;">+</div>
    <div class="plus-menu" id="plusMenu">
      <button id="plusIndividualBtn">Individual Chat</button>
      <button id="plusGroupBtn">Group Chat</button>
    </div>
  </div>

  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h4 id="modalTitle">New Group</h4>
      <div class="section-title">Group name</div>
      <input id="groupName" placeholder="Type group name..." />

      <div class="section-title">Add people (type email or phone and press Enter)</div>
      <input id="addMemberInput" placeholder="Email or phone" />

      <div class="section-title">Selected members</div>
      <div id="selectedMembers" style="min-height:40px;margin-bottom:8px;"></div>

      <div class="section-title">Contacts (tap to toggle)</div>
      <div class="contacts-list" id="contactsList"></div>

      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button id="cancelCreateGroup" class="btn ghost" style="width:auto;padding:8px 12px;">Cancel</button>
        <button id="createGroupBtn" class="btn primary" style="width:auto;padding:8px 12px;">Create Group</button>
      </div>
    </div>
  </div>

  <!-- Group options modal -->
  <div class="group-options-backdrop" id="groupOptionsBackdrop" aria-hidden="true">
    <div class="group-options" role="dialog" aria-modal="true" id="groupOptionsDialog">
      <div style="display:flex;justify-content:flex-end;"><button id="closeGroupOptions" class="btn ghost" style="padding:6px 8px;width:auto;height:auto;">Close</button></div>
      <div class="group-header">
        <div class="group-photo" id="groupPhoto">G</div>
        <div>
          <div id="groupOptionsName" style="font-weight:700;color:var(--primary);font-size:18px;">Group</div>
          <div id="groupOptionsSub" class="small">0 members</div>
        </div>
      </div>
      <div style="margin-bottom:8px;font-size:13px;color:var(--muted);">Members</div>
      <div id="groupMembersList" style="margin-bottom:12px;"></div>

      <div style="display:flex;gap:8px;justify-content:flex-end;">
        <button id="leaveGroupBtn" class="btn ghost" style="padding:8px 12px;">Leave Group</button>
        <button id="deleteGroupBtn" class="btn primary" style="padding:8px 12px;">Delete Group</button>
      </div>
    </div>
  </div>

  <div class="main-modal-backdrop" id="mainModalBackdrop">
    <div class="main-modal">
      <div class="close-modal" id="closeMainModal">×</div>
      <h3>Start New Chat</h3>
      <button id="openIndividualModalBtn">Individual Chat</button>
      <button id="openGroupModalBtn">Group Chat</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js';
    import { getDatabase, ref as dbRef, set, get, onValue, push, update, remove } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyBUH95hXYxMVCfhJglN4j3CReXy-CLYwmA',
      authDomain: 'live-messageinggkkh.firebaseapp.com',
      databaseURL: 'https://live-messageinggkkh-default-rtdb.firebaseio.com',
      projectId: 'live-messageinggkkh',
      storageBucket: 'live-messageinggkkh.appspot.com',
      messagingSenderId: '537475612761',
      appId: '1:537475612761:web:d00723c117383e54027148'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // DOM refs
    const authSection = document.getElementById('auth-section');
    const appSection = document.getElementById('app-section');
    const individualChat = document.getElementById('individual-chat-container');
    const floatingBtn = document.getElementById('floatingNewBtn');
    const plusMenu = document.getElementById('plusMenu');
    const addChatArea = document.getElementById('add-chat-area');
    const addChatIdentifier = document.getElementById('addChatIdentifier');
    const addBtn = document.getElementById('addChatBtn');
    const closeAdd = document.getElementById('closeAddChat');
    const chatList = document.getElementById('chat-list-container');
    const groupList = document.getElementById('group-list-container');
    const backBtn = document.getElementById('backToChatListBtn');
    const sendBtn = document.getElementById('sendChatMessageBtn');
    const msgInput = document.getElementById('chatMessageInput');
    const msgContainer = document.getElementById('chat-messages');
    const bottomNav = document.getElementById('bottom-nav');
    const authSubmitBtn = document.getElementById('authSubmitBtn');
    const email = document.getElementById('email');
    const pass = document.getElementById('password');
    const phone = document.getElementById('phoneNumber');
    const toSignIn = document.getElementById('toSignIn');
    const toSignUp = document.getElementById('toSignUp');
    const navHome = document.getElementById('nav-home');
    const navGroups = document.getElementById('nav-groups');
    const navGames = document.getElementById('nav-games');
    const navYou = document.getElementById('nav-you');
    const listTitle = document.getElementById('list-title');
    const welcomeText = document.querySelector('.welcome');

    // modal/group refs
    const modalBackdrop = document.getElementById('modalBackdrop');
    const createGroupBtn = document.getElementById('createGroupBtn');
    const cancelCreateGroup = document.getElementById('cancelCreateGroup');
    const groupNameInput = document.getElementById('groupName');
    const addMemberInput = document.getElementById('addMemberInput');
    const selectedMembersDiv = document.getElementById('selectedMembers');
    const contactsListDiv = document.getElementById('contactsList');

    const plusIndividualBtn = document.getElementById('plusIndividualBtn');
    const plusGroupBtn = document.getElementById('plusGroupBtn');

    const groupOptionsBackdrop = document.getElementById('groupOptionsBackdrop');
    const groupOptionsName = document.getElementById('groupOptionsName');
    const groupOptionsSub = document.getElementById('groupOptionsSub');
    const groupPhoto = document.getElementById('groupPhoto');
    const groupMembersList = document.getElementById('groupMembersList');
    const leaveGroupBtn = document.getElementById('leaveGroupBtn');
    const deleteGroupBtn = document.getElementById('deleteGroupBtn');
    const groupOptionsBtn = document.getElementById('groupOptionsBtn');
    const closeGroupOptions = document.getElementById('closeGroupOptions');

    // state
    let currentChat = null;
    let currentUser = null;
    let usersCache = {};
    let selectedGroupMembers = {};
    let isSigningUp = true;

    function updateAuthUI() {
      if (isSigningUp) {
        authSubmitBtn.textContent = 'Sign Up';
        welcomeText.innerHTML = 'Welcome,<br>to Zag Messenger.';
        if (phone && phone.parentElement) phone.parentElement.style.display = 'flex';
        toSignIn.style.display = 'block';
        toSignUp.style.display = 'none';
        authSubmitBtn.classList.add('primary');
        authSubmitBtn.classList.remove('ghost');
      } else {
        authSubmitBtn.textContent = 'Sign In';
        welcomeText.innerHTML = 'Welcome Back,<br>to Zag Messenger.';
        if (phone && phone.parentElement) phone.parentElement.style.display = 'none';
        toSignIn.style.display = 'none';
        toSignUp.style.display = 'block';
        authSubmitBtn.classList.add('primary');
        authSubmitBtn.classList.remove('ghost');
      }
    }
    toSignIn.addEventListener('click', () => { isSigningUp = false; updateAuthUI(); });
    toSignUp.addEventListener('click', () => { isSigningUp = true; updateAuthUI(); });
    updateAuthUI();

    async function createUserProfile(user) {
      if (!user) return;
      const userRef = dbRef(db, 'users/' + user.uid);
      const snap = await get(userRef);
      if (!snap.exists()) {
        await set(userRef, {
          email: user.email || '',
          uid: user.uid,
          phoneNumber: '+880' + (phone.value.trim() || '')
        });
      } else {
        const data = snap.val();
        if (!data.phoneNumber && phone.value.trim()) {
          await update(userRef, { phoneNumber: '+880' + phone.value.trim() });
        }
      }
    }

    authSubmitBtn.addEventListener('click', async () => {
      const e = (email.value || '').trim();
      const p = (pass.value || '').trim();
      const ph = (phone.value || '').trim();

      if (!e || !p) {
        return alert('Please enter email and password.');
      }
      if (isSigningUp && !ph) {
        return alert('Please enter your phone number for sign up.');
      }

      try {
        if (isSigningUp) {
          const userCredential = await createUserWithEmailAndPassword(auth, e, p);
          await createUserProfile(userCredential.user);
        } else {
          await signInWithEmailAndPassword(auth, e, p);
        }
      } catch (err) {
        alert((isSigningUp ? 'Sign up' : 'Sign in') + ' failed: ' + err.message);
        console.error(err);
      }
    });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        await createUserProfile(user);
        loadUsersCache();
        loadChats();
        loadGroups();
      }
      updateUI(user);
      updateFloatingVisibility();
    });

    function updateUI(user) {
      if (user) {
        authSection.style.display = 'none';
        appSection.style.display = 'block';
        individualChat.style.display = 'none';
        bottomNav.style.display = 'flex';
        navHome.classList.add('active');
        navGroups.classList.remove('active');
        listTitle.innerText = 'My chats';
        chatList.style.display = 'block';
        groupList.style.display = 'none';
      } else {
        authSection.style.display = 'flex';
        appSection.style.display = 'none';
        individualChat.style.display = 'none';
        floatingBtn.style.display = 'none';
        bottomNav.style.display = 'flex';
        navHome.classList.remove('active');
        navGroups.classList.remove('active');
      }
    }

    function updateFloatingVisibility() {
      const appVisible = appSection.style.display !== 'none';
      const chatVisible = individualChat.style.display !== 'none';
      const allowedNav = navHome.classList.contains('active') || navGroups.classList.contains('active');

      if (currentUser && appVisible && !chatVisible && allowedNav) {
        floatingBtn.style.display = 'flex';
      } else {
        floatingBtn.style.display = 'none';
        plusMenu.style.display = 'none';
      }
    }

    function loadUsersCache() {
      const usersRef = dbRef(db, 'users');
      onValue(usersRef, snap => {
        usersCache = {};
        contactsListDiv.innerHTML = '';
        snap.forEach(s => {
          const u = s.val();
          if (!u || !u.uid) return;
          usersCache[u.uid] = u;
          if (currentUser && u.uid !== currentUser.uid) {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.dataset.uid = u.uid;
            div.innerHTML = `<div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(180deg,#dbeeff,#c1ddff);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);">${(u.email||'U').charAt(0).toUpperCase()}</div>
                              <div style="flex:1;">
                                <div style="font-weight:700;color:var(--primary);font-size:14px;">${u.email || u.phoneNumber || 'Unknown'}</div>
                                <div class="small">${u.phoneNumber || ''}</div>
                              </div>`;
            div.addEventListener('click', () => {
              if (selectedGroupMembers[u.uid]) {
                delete selectedGroupMembers[u.uid];
                div.style.opacity = '1';
              } else {
                selectedGroupMembers[u.uid] = u;
                div.style.opacity = '0.6';
              }
              renderSelectedMembers();
            });
            contactsListDiv.appendChild(div);
          }
        });
      });
    }

    function renderSelectedMembers() {
      selectedMembersDiv.innerHTML = '';
      Object.values(selectedGroupMembers).forEach(u => {
        const span = document.createElement('span');
        span.style.display = 'inline-block';
        span.style.padding = '6px 10px';
        span.style.marginRight = '6px';
        span.style.background = '#f0f6ff';
        span.style.borderRadius = '999px';
        span.style.fontSize = '13px';
        span.textContent = u.email || u.phoneNumber || 'Member';
        selectedMembersDiv.appendChild(span);
      });
    }

    function escapeHtml(unsafe) {
      if (unsafe === undefined || unsafe === null) return '';
      return String(unsafe)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function formatTime(ms) {
      if (!ms) return '';
      const d = new Date(Number(ms));
      let hours = d.getHours();
      const minutes = d.getMinutes();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      if (hours === 0) hours = 12;
      const mins = minutes < 10 ? '0' + minutes : minutes;
      return hours + ':' + mins + ' ' + ampm;
    }

    function loadChats() {
      chatList.innerHTML = '';
      if (!currentUser) {
        chatList.innerHTML = '<div class="small">Sign in to see chats.</div>';
        return;
      }
      const usersRef = dbRef(db, 'users');
      get(usersRef).then(snap => {
        if (!snap.exists()) {
          chatList.innerHTML = '<div class="small">No contacts yet.</div>';
          return;
        }
        chatList.innerHTML = '';
        snap.forEach(s => {
          const u = s.val();
          if (u.uid === currentUser.uid) return;
          const item = document.createElement('div');
          item.className = 'chat-item';
          item.dataset.uid = u.uid;
          item.innerHTML = `<div class="avatar">${(u.email||'U').charAt(0).toUpperCase()}</div>
                            <div class="chat-meta">
                              <div class="name">${u.email || u.phoneNumber || 'User'}</div>
                              <div class="sub">${u.phoneNumber || ''}</div>
                            </div>`;
          item.addEventListener('click', () => {
            openPrivateChatWith(u);
          });
          chatList.appendChild(item);
        });
      }).catch(err => {
        console.error('loadChats error', err);
        chatList.innerHTML = '<div class="small">Error loading chats.</div>';
      });
    }

    function openPrivateChatWith(userObj) {
      if (!currentUser) return alert('Not signed in');
      const chatId = [currentUser.uid, userObj.uid].sort().join('_');
      currentChat = { type: 'private', id: chatId, with: userObj };
      document.getElementById('current-chat-avatar').textContent = (userObj.email||'U').charAt(0).toUpperCase();
      document.getElementById('current-chat-name').textContent = userObj.email || userObj.phoneNumber || 'User';
      document.getElementById('current-chat-sub').textContent = userObj.phoneNumber || '';

      appSection.style.display = 'none';
      individualChat.style.display = 'flex';
      msgContainer.innerHTML = '';
      updateFloatingVisibility();

      const messagesRef = dbRef(db, 'messages/' + chatId);
      onValue(messagesRef, snap => {
        msgContainer.innerHTML = '';
        snap.forEach(child => {
          const m = child.val();
          const isSent = m.sender === currentUser.uid;
          const div = document.createElement('div');
          div.className = 'bubble ' + (isSent ? 'sent' : 'received');
          div.innerHTML = `<div>${escapeHtml(m.text)}</div>
                           <div class="msg-meta">${formatTime(m.timestamp)}</div>`;
          msgContainer.appendChild(div);
        });
        msgContainer.scrollTop = msgContainer.scrollHeight;
      });
    }

    function openGroupChat(groupObj) {
      if (!currentUser) return alert('Not signed in');
      currentChat = { type: 'group', id: groupObj.id, group: groupObj };
      document.getElementById('current-chat-avatar').textContent = (groupObj.name||'G').charAt(0).toUpperCase();
      document.getElementById('current-chat-name').textContent = groupObj.name || 'Group';
      document.getElementById('current-chat-sub').textContent = (Object.keys(groupObj.members||{}).length || 0) + ' members';

      appSection.style.display = 'none';
      individualChat.style.display = 'flex';
      msgContainer.innerHTML = '';
      updateFloatingVisibility();

      const messagesRef = dbRef(db, 'messages/' + groupObj.id);
      onValue(messagesRef, snap => {
        msgContainer.innerHTML = '';
        snap.forEach(child => {
          const m = child.val();
          const isSent = m.sender === currentUser.uid;
          const div = document.createElement('div');
          div.className = 'bubble ' + (isSent ? 'sent' : 'received');

          let senderLabel = '';
          if (!isSent) {
            const sender = usersCache[m.sender];
            if (sender) senderLabel = escapeHtml(sender.email || sender.phoneNumber || 'Member');
            else senderLabel = 'Member';
          }

          div.innerHTML = `${!isSent ? `<div style="font-weight:700;font-size:13px;margin-bottom:6px;">${senderLabel}</div>` : ''}
                           <div>${escapeHtml(m.text)}</div>
                           <div class="msg-meta">${formatTime(m.timestamp)}</div>`;
          msgContainer.appendChild(div);
        });
        msgContainer.scrollTop = msgContainer.scrollHeight;
      });
    }

    backBtn.addEventListener('click', () => {
      individualChat.style.display = 'none';
      appSection.style.display = 'block';
      currentChat = null;
      updateFloatingVisibility();
    });

    sendBtn.addEventListener('click', async () => {
      const text = (msgInput.value || '').trim();
      if (!text) return;
      if (!currentChat) return alert('Open a chat first.');
      const chatId = currentChat.id;
      const messagesRef = dbRef(db, 'messages/' + chatId);
      const newMsgRef = push(messagesRef);
      await set(newMsgRef, {
        text,
        sender: currentUser.uid,
        senderEmail: currentUser.email || '',
        timestamp: Date.now()
      });
      msgInput.value = '';
    });

    msgInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendBtn.click();
      }
    });

    floatingBtn.addEventListener('click', (e) => {
      if (plusMenu.style.display === 'flex') {
        plusMenu.style.display = 'none';
      } else {
        plusMenu.style.display = 'flex';
        setTimeout(() => { plusMenu.style.display = 'none'; }, 6000);
      }
    });

    plusIndividualBtn.addEventListener('click', () => {
      plusMenu.style.display = 'none';
      addChatArea.style.display = 'block';
      addChatIdentifier.focus();
      updateFloatingVisibility();
    });
    plusGroupBtn.addEventListener('click', () => {
      plusMenu.style.display = 'none';
      modalBackdrop.style.display = 'flex';
    });

    closeAdd.addEventListener('click', () => {
      addChatArea.style.display = 'none';
      updateFloatingVisibility();
    });

    addBtn.addEventListener('click', async () => {
      const val = (addChatIdentifier.value || '').trim();
      if (!val) return alert('Enter email or phone to add.');
      const usersRef = dbRef(db, 'users');
      const snapshot = await get(usersRef);
      let found = null;
      snapshot.forEach(s => {
        const u = s.val();
        if (!u) return;
        if (u.email === val || u.phoneNumber === val || ('+880'+val) === u.phoneNumber) {
          found = u;
        }
      });
      if (!found) {
        return alert('User not found in directory. They must sign up first.');
      }
      openPrivateChatWith(found);
      addChatArea.style.display = 'none';
      addChatIdentifier.value = '';
      updateFloatingVisibility();
    });

    navGroups.addEventListener('click', () => {
      navGroups.classList.add('active');
      navHome.classList.remove('active');
      listTitle.innerText = 'Groups';
      chatList.style.display = 'none';
      groupList.style.display = 'block';
      updateFloatingVisibility();
      loadGroups();
    });
    navHome.addEventListener('click', () => {
      navHome.classList.add('active');
      navGroups.classList.remove('active');
      listTitle.innerText = 'My chats';
      chatList.style.display = 'block';
      groupList.style.display = 'none';
      updateFloatingVisibility();
      loadChats();
    });

    cancelCreateGroup.addEventListener('click', () => {
      modalBackdrop.style.display = 'none';
      updateFloatingVisibility();
    });
    addMemberInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const q = (addMemberInput.value || '').trim();
        if (!q) return;
        let found = null;
        Object.values(usersCache).forEach(u => {
          if (u.email === q || u.phoneNumber === q || ('+880'+q) === u.phoneNumber) found = u;
        });
        if (found) {
          selectedGroupMembers[found.uid] = found;
          renderSelectedMembers();
          addMemberInput.value = '';
        } else {
          alert('User not found');
        }
      }
    });

    createGroupBtn.addEventListener('click', async () => {
      const name = (groupNameInput.value || '').trim();
      if (!name) return alert('Enter group name');
      const memberUids = Object.keys(selectedGroupMembers);
      if (memberUids.length === 0) return alert('Add at least one member');
      const groupsRef = dbRef(db, 'groups');
      const newGroupRef = push(groupsRef);
      const groupId = newGroupRef.key;
      const groupData = {
        id: groupId,
        name,
        members: { [currentUser.uid]: true },
        createdAt: Date.now(),
        createdBy: currentUser.uid
      };
      memberUids.forEach(uid => groupData.members[uid] = true);
      await set(newGroupRef, groupData);
      modalBackdrop.style.display = 'none';
      groupNameInput.value = '';
      selectedGroupMembers = {};
      renderSelectedMembers();
      alert('Group created');
      loadGroups();
      updateFloatingVisibility();
    });

    function loadGroups() {
      groupList.innerHTML = '';
      if (!currentUser) {
        groupList.innerHTML = '<div class="small">Sign in to see groups.</div>';
        return;
      }
      const groupsRef = dbRef(db, 'groups');
      get(groupsRef).then(snap => {
        groupList.innerHTML = '';
        if (!snap.exists()) return;
        snap.forEach(s => {
          const g = s.val();
          if (!g || !g.members) return;
          if (g.members[currentUser.uid]) {
            const div = document.createElement('div');
            div.className = 'chat-item';
            div.innerHTML = `<div class="avatar">G</div>
                             <div class="chat-meta">
                               <div class="name">${g.name}</div>
                               <div class="sub">${Object.keys(g.members).length} members</div>
                             </div>`;
            div.addEventListener('click', () => {
              openGroupChat(g);
            });
            groupList.appendChild(div);
          }
        });
      }).catch(err => {
        console.error('loadGroups error', err);
        groupList.innerHTML = '<div class="small">Error loading groups.</div>';
      });
    }

    navYou.addEventListener('click', async () => {
      if (!currentUser) return alert('Not signed in');
      const ok = confirm('Sign out?');
      if (ok) {
        await signOut(auth);
      }
    });

    window.addEventListener('resize', updateFloatingVisibility);
    window.addEventListener('focus', updateFloatingVisibility);

    // Keep input area in view smoothly when keyboard appears (mobile)
    function adjustInputForViewport() {
      const wrapper = document.querySelector('.chat-input-area-wrapper');
      if (!wrapper) return;
      if (window.visualViewport) {
        const offset = window.innerHeight - window.visualViewport.height;
        // limit how much it goes up so it doesn't fly away
        const limited = Math.min(offset + 12, 180);
        wrapper.style.bottom = (limited > 10 ? (limited + 10) : 72) + 'px';
      } else {
        // fallback small lift on focus
        wrapper.style.bottom = '110px';
        setTimeout(() => { wrapper.style.bottom = '72px'; }, 900);
      }
    }

    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', () => {
        // animate slightly for smoothness
        adjustInputForViewport();
      });
      window.visualViewport.addEventListener('scroll', () => {
        adjustInputForViewport();
      });
    }

    msgInput.addEventListener('focus', () => {
      // small lift but not too much
      adjustInputForViewport();
    });
    msgInput.addEventListener('blur', () => {
      const wrapper = document.querySelector('.chat-input-area-wrapper');
      wrapper.style.bottom = '72px';
    });

    // Group options behavior
    groupOptionsBtn.addEventListener('click', async () => {
      if (!currentChat) return;
      if (currentChat.type === 'group') {
        // read fresh group data
        const gRef = dbRef(db, 'groups/' + currentChat.id);
        const snap = await get(gRef);
        if (!snap.exists()) return alert('Group info not found');
        const g = snap.val();
        showGroupOptions(g);
      } else {
        // private chat: show basic contact info
        const other = currentChat.with;
        groupPhoto.textContent = (other.email||'U').charAt(0).toUpperCase();
        groupOptionsName.textContent = other.email || other.phoneNumber || 'Contact';
        groupOptionsSub.textContent = other.phoneNumber || '';
        groupMembersList.innerHTML = `<div class="member-item"><div class="member-photo" style="width:40px;height:40px;border-radius:50%;background:linear-gradient(180deg,#dbeeff,#c1ddff);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);">${(other.email||'U').charAt(0).toUpperCase()}</div>
          <div class="meta"><div style="font-weight:700;color:var(--primary);">${other.email||other.phoneNumber}</div><div class="small">${other.phoneNumber||''}</div></div></div>`;
        // hide delete/leave for private
        deleteGroupBtn.style.display = 'none';
        leaveGroupBtn.style.display = 'none';
        groupOptionsBackdrop.style.display = 'flex';
      }
    });

    function showGroupOptions(g) {
      groupPhoto.textContent = (g.name||'G').charAt(0).toUpperCase();
      groupOptionsName.textContent = g.name || 'Group';
      groupOptionsSub.textContent = (Object.keys(g.members||{}).length || 0) + ' members';
      groupMembersList.innerHTML = '';
      // fetch member details from usersCache
      Object.keys(g.members || {}).forEach(uid => {
        const u = usersCache[uid] || { email: 'Unknown', phoneNumber: '' };
        const div = document.createElement('div');
        div.className = 'member-item';
        div.innerHTML = `<div class="member-photo" style="width:40px;height:40px;border-radius:50%;background:linear-gradient(180deg,#dbeeff,#c1ddff);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);">${(u.email||'U').charAt(0).toUpperCase()}</div>
                         <div class="meta"><div style="font-weight:700;color:var(--primary);font-size:14px;">${escapeHtml(u.email||u.phoneNumber||'Member')}</div>
                         <div class="small">${escapeHtml(u.phoneNumber||'')}</div></div>`;
        if (uid === g.createdBy) {
          const adm = document.createElement('div');
          adm.textContent = 'Admin';
          adm.style.fontSize = '12px';
          adm.style.color = 'var(--primary)';
          adm.style.fontWeight = '700';
          div.appendChild(adm);
        }
        groupMembersList.appendChild(div);
      });
      // show/hide delete button based on admin
      if (currentUser && g.createdBy === currentUser.uid) {
        deleteGroupBtn.style.display = 'inline-block';
        leaveGroupBtn.style.display = 'none';
      } else {
        deleteGroupBtn.style.display = 'none';
        leaveGroupBtn.style.display = 'inline-block';
      }
      // store currently viewed group on elements
      groupOptionsBackdrop.dataset.groupId = g.id;
      groupOptionsBackdrop.style.display = 'flex';
    }

    closeGroupOptions.addEventListener('click', () => {
      groupOptionsBackdrop.style.display = 'none';
    });

    leaveGroupBtn.addEventListener('click', async () => {
      const gid = groupOptionsBackdrop.dataset.groupId;
      if (!gid) return;
      const ok = confirm('Leave this group?');
      if (!ok) return;
      // remove currentUser from members
      await update(dbRef(db, 'groups/' + gid + '/members'), { [currentUser.uid]: null });
      groupOptionsBackdrop.style.display = 'none';
      individualChat.style.display = 'none';
      appSection.style.display = 'block';
      loadGroups();
      alert('You left the group');
    });

    deleteGroupBtn.addEventListener('click', async () => {
      const gid = groupOptionsBackdrop.dataset.groupId;
      if (!gid) return;
      const ok = confirm('Delete this group for everyone? This cannot be undone.');
      if (!ok) return;
      // remove group and messages
      await remove(dbRef(db, 'groups/' + gid));
      await remove(dbRef(db, 'messages/' + gid));
      groupOptionsBackdrop.style.display = 'none';
      individualChat.style.display = 'none';
      appSection.style.display = 'block';
      loadGroups();
      alert('Group deleted');
    });

    // small modal delegations
    document.addEventListener('click', (e) => {
      const id = e.target && e.target.id;
      if (id === 'closeMainModal') {
        document.querySelector('.phone').classList.remove('blurred-bg');
        const m = document.getElementById('mainModalBackdrop');
        if (m) m.style.display = 'none';
      } else if (id === 'openIndividualModalBtn') {
        document.querySelector('.phone').classList.remove('blurred-bg');
        const m = document.getElementById('mainModalBackdrop');
        if (m) m.style.display = 'none';
        addChatArea.style.display = 'block';
        addChatIdentifier.focus();
      } else if (id === 'openGroupModalBtn') {
        document.querySelector('.phone').classList.remove('blurred-bg');
        const m = document.getElementById('mainModalBackdrop');
        if (m) m.style.display = 'none';
        modalBackdrop.style.display = 'flex';
      }
    });

    floatingBtn.addEventListener('dblclick', () => {
      const main = document.getElementById('mainModalBackdrop');
      if (main) {
        document.querySelector('.phone').classList.add('blurred-bg');
        main.style.display = 'flex';
      }
    });

    console.log('Enhanced UI loaded');
  </script>

<!-- slide-in animation behavior (injected) -->
<script>
(function(){
  // Find root elements
  const phone = document.querySelector('.phone') || document.getElementById('phoneRoot') || document.body;
  const appSection = document.getElementById('app-section');
  const chatContainer = document.getElementById('individual-chat-container');
  const backBtn = document.getElementById('backToChatListBtn');

  // Safety: ensure elements exist
  if (!appSection || !chatContainer) {
    console.warn('Animation injector: required elements not found. Skipping slide-in injection.');
    return;
  }

  // Prepare chat container initial state
  chatContainer.classList.add('chat-off');

  // Helper to open chat with animation
  function openChatAnimated() {
    // hide top banner
    if (phone && phone.classList) phone.classList.add('hide-top');

    // slide app section left / fade
    appSection.classList.add('app-hidden');

    // show chat container and trigger slide-in
    chatContainer.style.display = 'flex';
    // force reflow to ensure transition triggers
    void chatContainer.offsetWidth;
    chatContainer.classList.remove('chat-off');
    chatContainer.classList.add('chat-on');

    // scroll messages to bottom if present after animation starts
    setTimeout(() => {
      try {
        const msgs = chatContainer.querySelector('.chat-messages');
        if (msgs) msgs.scrollTop = msgs.scrollHeight;
      } catch(e){}
    }, 120);
  }

  // Helper to close chat and restore
  function closeChatAnimated() {
    // restore top banner
    if (phone && phone.classList) phone.classList.remove('hide-top');

    // restore app section
    appSection.classList.remove('app-hidden');

    // slide chat out to right and hide after transition
    chatContainer.classList.remove('chat-on');
    chatContainer.classList.add('chat-off');
    // wait for transition end then hide
    const t = setTimeout(() => {
      try { chatContainer.style.display = 'none'; } catch(e){}
      clearTimeout(t);
    }, 420);
  }

  // Attach to existing .chat-item click handlers (non-invasive)
  function attachToChatItems() {
    const items = document.querySelectorAll('.chat-item');
    items.forEach(item => {
      // avoid attaching multiple times
      if (item.dataset.slideAttached) return;
      item.addEventListener('click', (ev) => {
        // If your existing code opens the chat, we still run animation in addition.
        // Delay a tiny bit so existing click handlers (which may swap views) can run first.
        setTimeout(openChatAnimated, 60);
      });
      item.dataset.slideAttached = '1';
    });
  }

  // Attach to back button to reverse animation
  if (backBtn) {
    const orig = backBtn.onclick;
    backBtn.addEventListener('click', (ev) => {
      // run our animation close
      closeChatAnimated();
      // allow any original logic (if present) to run after a short delay
      setTimeout(() => { try { if (typeof orig === 'function') orig.call(backBtn, ev); } catch(e){} }, 160);
    }, {passive:false});
  }

  // Initial attach and try re-attaching when DOM changes (for SPA behavior)
  attachToChatItems();
  // observe for new chat items
  const observer = new MutationObserver((mutList) => {
    attachToChatItems();
  });
  observer.observe(appSection, { childList: true, subtree: true });

  // Expose for debugging
  window.__zagSlide = { openChatAnimated, closeChatAnimated };

})();
</script>

</body>
</html>

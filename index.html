<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live Messaging App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .container {
      width: 100%;
      max-width: 480px;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      box-sizing: border-box;
      margin-top: 10px;
    }
    h2, h3 { text-align: center; }
    input, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      border: none;
      background: #007bff;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover { background: #0056b3; }
    button:disabled { background: #cccccc; cursor: not-allowed; }
    .message { padding: 8px; margin: 8px 0; border-radius: 5px; }
    .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Live Messaging App</h2>
    <div id="auth-section">
      <div id="auth-message-area"></div>
      <input type="email" id="email" placeholder="Email"/>
      <input type="password" id="password" placeholder="Password"/>
      <button id="signupBtn">Sign Up</button>
      <button id="loginBtn">Sign In</button>
    </div>

    <div id="app-section" style="display:none;">
      <h3>Upload Post</h3>
      <input type="file" id="postImage"/>
      <button id="uploadPostBtn">Upload</button>
      <div id="post-message-area"></div>
      <h3>Posts</h3>
      <div id="no-posts-message" style="display:block;">No posts yet.</div>
      <div id="posts-grid-container"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUH95hXYxMVCfhJglN4j3CReXy-CLYwmA",
      authDomain: "live-messageinggkkh.firebaseapp.com",
      databaseURL: "https://live-messageinggkkh-default-rtdb.firebaseio.com",
      projectId: "live-messageinggkkh",
      storageBucket: "live-messageinggkkh.appspot.com",
      messagingSenderId: "537475612761",
      appId: "1:537475612761:web:d00723c117383e54027148"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const signupBtn = document.getElementById("signupBtn");
    const loginBtn = document.getElementById("loginBtn");
    const uploadPostBtn = document.getElementById("uploadPostBtn");
    const postImageInput = document.getElementById("postImage");
    const postMessageArea = document.getElementById("post-message-area");

    function displayMessage(area, message, type) {
      area.innerHTML = `<div class='message ${type}'>${message}</div>`;
      setTimeout(() => area.innerHTML = '', 4000);
    }

    async function createUserProfile(user) {
      await set(ref(db, `users/${user.uid}`), { email: user.email, uid: user.uid });
    }

    signupBtn.onclick = async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!email || !password) return displayMessage(authMessageArea, "Email and password required", "error");
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await createUserProfile(userCredential.user);
        document.getElementById("auth-section").style.display = "none";
        document.getElementById("app-section").style.display = "block";
      } catch (e) {
        displayMessage(authMessageArea, e.message, "error");
      }
    };

    loginBtn.onclick = async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!email || !password) return displayMessage(authMessageArea, "Email and password required", "error");
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        await createUserProfile(userCredential.user);
        document.getElementById("auth-section").style.display = "none";
        document.getElementById("app-section").style.display = "block";
      } catch (e) {
        displayMessage(authMessageArea, e.message, "error");
      }
    };

    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById("auth-section").style.display = "none";
        document.getElementById("app-section").style.display = "block";
      }
    });

    // ImgBB uploader
    async function uploadToImgBB(file) {
      const formData = new FormData();
      formData.append("image", file);
      const apiKey = "dd99dd6508ecaf9c5a78e1d20a234937"; // user's API key
      const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
        method: "POST",
        body: formData
      });
      const data = await response.json();
      if (!data.success) throw new Error("ImgBB upload failed");
      return data.data.url;
    }

    uploadPostBtn.onclick = async () => {
      const file = postImageInput.files[0];
      if (!file) return displayMessage(postMessageArea, "Select an image file first.", "error");
      if (!auth.currentUser) return displayMessage(postMessageArea, "You must be logged in.", "error");

      uploadPostBtn.disabled = true;
      try {
        const imageUrl = await uploadToImgBB(file);
        await push(ref(db, "posts"), {
          imageUrl: imageUrl,
          timestamp: Date.now(),
          userId: auth.currentUser.uid,
          userEmail: auth.currentUser.email
        });
        displayMessage(postMessageArea, "Post uploaded successfully!", "success");
        postImageInput.value = "";
      } catch (e) {
        console.error("Upload error:", e);
        displayMessage(postMessageArea, "Upload failed: " + e.message, "error");
      } finally {
        uploadPostBtn.disabled = false;
      }
    };
  </script>
</body>
</html>

--- START OF FILE xxx.html ---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zag Messenger — User fixes (scroll fix, side menu, auth page header fix)</title>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet" />
  <style>
    :root{
      --input-area-height:74px;
      --bottom-nav-height:64px;
      --bg:#e9f1ff;
      --primary:#0b60d6;
      --primary-dark:#0849a6;
      --muted:#9aaecf;
      --hand-font:'Patrick Hand', 'Segoe UI', Arial, sans-serif;
      --header-height:56px;
      --wave-height:28px;
      --fixed-list-header-height:48px; /* New: height of the fixed 'My chats' header */
      --fab-top-offset:400px; /* Adjusted: to move the + to the black circle's position */
    }
    html,body{height:100%;margin:0;font-family:var(--hand-font);background:linear-gradient(180deg,var(--bg),#eef6ff 60%);overflow:hidden;}
    .phone{
      width:100%;
      height:100vh;
      background:#fff;
      display:flex;
      flex-direction:column;
      box-sizing:border-box;
      /* Padding top to account for top header + wave */
      padding-top: calc(var(--header-height) + var(--wave-height));
      position:relative;
    }

    /* fixed top header */
    .header{
      display:flex;
      align-items:center;
      padding:10px 14px;
      gap:10px;
      background:linear-gradient(180deg,var(--primary),var(--primary-dark));
      color:#fff;
      position:fixed;
      top:0;
      left:0;
      right:0;
      height:var(--header-height);
      z-index:120;
      box-sizing:border-box;
    }
    .logo{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;overflow:hidden;background:linear-gradient(180deg,#fff,#f7fbff);}
    .logo img{width:100%;height:100%;object-fit:cover;border-radius:50%;display:block;}
    
    .title{font-size:20px;color:#fff;font-weight:700;}
    .menu{margin-left:auto;font-size:20px;color:#fff; cursor:pointer;} /* Added cursor */

    /* wave under the header: now blue fill per user's request */
    .wave-top{
      width:100%;
      height:var(--wave-height);
      position:fixed;
      top:var(--header-height);
      left:0;
      right:0;
      z-index:119;
      margin-top:0;
    }
    .wave-top svg{width:100%;height:100%;display:block;}
    .wave-top path{fill:var(--primary);} 

    /* Fixed header for 'My chats' list */
    .fixed-list-header {
      position: fixed;
      top: calc(var(--header-height) + var(--wave-height)); 
      left: 0;
      right: 0;
      z-index: 100;
      padding: 12px 18px 8px 18px;
      background: var(--bg); 
      box-sizing: border-box;
      height: var(--fixed-list-header-height);
      display: flex; 
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 10px rgba(0,0,0,0.02);
    }
    .fixed-list-header h3 {
        color: var(--primary);
        margin: 0;
    }
    .fixed-list-header .top-controls{
       display:flex;
       align-items:center;
       gap:12px;
       justify-content:space-between;
       width: 100%;
    }
    
    .auth{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;padding:20px;overflow-y:auto;background:#f0f4fc;}
    .welcome{font-size:22px;color:var(--primary);}
    .sub{color:var(--muted);font-size:13px;margin-bottom:12px;}
    input{border:1px solid rgba(75,134,230,0.08);border-radius:10px;padding:12px 14px;font-size:15px;background:linear-gradient(180deg,#fff,#fbfdff);font-family:var(--hand-font);color:var(--primary);width:90%;max-width:360px;margin-bottom:10px;box-sizing:border-box;}
    .phone-group{display:flex;align-items:center;gap:8px;width:90%;max-width:360px;margin-bottom:10px;}
    .country-code{border:1px solid rgba(75,134,230,0.08);border-radius:10px;padding:12px;width:70px;text-align:center;background:linear-gradient(180deg,#fff,#fbfdff);color:var(--primary);}
    .btn{padding:10px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700;font-size:15px;box-shadow:0 6px 14px rgba(75,134,230,0.08);width:90%;max-width:360px;margin-bottom:8px;font-family:var(--hand-font);}
    .primary{background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;}
    .ghost{background:#f6f9ff;color:var(--primary);}
    .toggle-btns{display:flex;gap:12px;margin-top:12px;flex-direction:column;align-items:center;}
    .toggle-btns .btn{width:auto;padding:8px 16px;}
    .app{
        display:none;
        flex:1;
        overflow-y:auto;
        /* UPDATED: Increased padding-top to ensure content starts safely below the fixed header */
        padding:calc(var(--fixed-list-header-height) + 8px) 18px 120px 18px; 
        box-sizing:border-box;
    }
    .chats h3{color:var(--primary);margin:8px 0 12px;}
    .chat-item{display:flex;gap:10px;align-items:center;padding:12px;background:linear-gradient(180deg,#fff,#fbfdff);border-radius:10px;margin-bottom:12px;border:1px solid rgba(75,134,230,0.06);cursor:pointer;}
    .avatar{width:52px;height:52px;border-radius:50%;background:linear-gradient(180deg,#dbeeff,#c1ddff);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);font-size:18px;}
    .chat-meta{flex:1;}
    .chat-meta .name{font-weight:700;color:var(--primary);font-size:16px;}
    .chat-meta .sub{font-size:13px;color:var(--muted);margin-top:4px;}
    #add-chat-area{display:none;margin-bottom:12px;position:relative;}
    #closeAddChat{position:absolute;top:-10px;right:-10px;background:#fff;border:2px solid #ccc;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold;color:#777;}

    /* Floating + repositioned to the requested position (black circle) */
    .floating-new{
      position:fixed;
      right:20px;
      top: calc(var(--header-height) + var(--wave-height) + var(--fab-top-offset));
      width:64px;
      height:64px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(180deg,var(--primary),var(--primary-dark));
      color:#fff;
      box-shadow:0 12px 28px rgba(11,96,214,0.2);
      border:6px solid #fff;
      font-weight:700;
      cursor:pointer;
      z-index:140;
    }
    .plus-menu{
      position:fixed;
      right:18px;
      top: calc(var(--header-height) + var(--wave-height) + var(--fab-top-offset) - 80px);
      width:200px;
      background:#fff;
      border-radius:10px;
      padding:8px;
      box-shadow:0 20px 60px rgba(0,0,0,0.12);
      z-index:150;
      display:none;
      flex-direction:column;
      gap:8px;
    }

    .bottom-nav{position:fixed;left:0;bottom:0;width:100%;background:linear-gradient(180deg,#fff,#f6fbff);border-top:1px solid rgba(0,0,0,0.03);padding:14px;text-align:center;color:var(--primary);font-size:18px;font-weight:700;z-index:45;display:flex;gap:10px;justify-content:center;align-items:center;}
    .bottom-nav span{cursor:pointer;padding:6px 10px;border-radius:8px;}
    .bottom-nav .active{background:linear-gradient(180deg,#eff7ff,#dfeffe);box-shadow:0 6px 14px rgba(11,96,214,0.06);}

    .chat-screen{display:none;flex-direction:column;flex:1;overflow:hidden;padding:0;box-sizing:border-box;background-image: url('bg.png');background-repeat:no-repeat;background-size:cover;background-position:center;}

    /* chat header now positioned below header+wave when visible */
    .chat-header{
      display:flex;
      align-items:center;
      padding:10px 12px;
      border-bottom:1px dashed rgba(75,134,230,0.04);
      margin-bottom:8px;
      z-index:140;
      gap:10px;
      position:fixed;
      left:0;
      right:0;
      background:linear-gradient(180deg,#ffffff,#fbfdff);
      box-shadow:0 6px 20px rgba(10,30,80,0.06);
      height:var(--header-height);
      box-sizing:border-box;
      top: calc(var(--header-height) + var(--wave-height));
    }
    .chat-header-left{flex:0 0 auto;}
    .chat-header-center{flex:1;display:flex;align-items:center;justify-content:center;gap:10px;min-width:0;}
    .chat-header-center .avatar{width:44px;height:44px;border-radius:50%;flex-shrink:0;}
    .chat-center-text{min-width:0;text-align:left;max-width:60vw;}
    .chat-center-text .chat-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:700;color:var(--primary);font-size:16px;max-width:100%;}
    .chat-center-text .small{font-size:12px;color:var(--muted);opacity:0.9;margin-top:3px;}
    #backToChatListBtn{padding:6px 10px !important;border-radius:8px !important;font-size:14px !important;min-width:56px;}
    .chat-menu-btn{
      padding:6px 10px;
      border-radius:8px;
      border:none;
      background:linear-gradient(180deg,var(--primary),var(--primary-dark));
      color:#fff;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 4px 8px rgba(11,96,214,0.06);
    }
    .chat-messages{
      flex:1;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:8px;
      padding:6px;
      padding-top: calc(var(--header-height) + var(--wave-height) + var(--header-height) + 12px);
      padding-bottom:120px; 
      box-sizing:border-box;
      background-image: url('bg.png');
      background-repeat: no-repeat;
      background-size: cover;
      background-position: center;
    }
    .bubble{padding:10px 14px;border-radius:18px;max-width:78%;line-height:1.4;box-shadow:0 6px 14px rgba(10,30,80,0.04);margin-bottom:8px;}
    .bubble.sent{align-self:flex-end;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;}
    .bubble.received{align-self:flex-start;background:#fff;color:var(--primary);border:1px solid rgba(75,134,230,0.04);}
    .msg-meta{display:block;font-size:11px;opacity:0.85;margin-top:6px;}

    .chat-input-area-wrapper{
      position:fixed;
      left:0;
      right:0;
      bottom:64px; 
      padding:8px 18px 10px 18px;
      /* Background transparent as requested */
      background:transparent; 
      box-sizing:border-box;
      width:100%;
      z-index:80;
      display:flex;
      justify-content:center;
      border-top:1px solid rgba(11,96,214,0.08);
      transition: bottom 260ms cubic-bezier(.22,.9,.32,1), transform 260ms ease;
      transform: translateZ(0);
    }
    .chat-input{display:flex;gap:8px;align-items:center;border-radius:999px;padding:8px;background:#fff;border:2px solid var(--primary);transition:border-color 0.3s, transform 0.1s;max-width:920px;width:100%;box-sizing:border-box;}
    @keyframes gentleShake{0%,100%{transform:translateX(0);}25%{transform:translateX(-2px);}75%{transform:translateX(2px);}}
    .chat-input.typing{animation:gentleShake 0.25s ease-in-out;}
    .chat-input input{flex:1;border:none;outline:none;font-size:15px;padding:10px 6px;font-family:var(--hand-font);color:var(--primary);background:transparent;}
    .send-btn{width:44px;height:44px;border-radius:50%;border:none;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;box-shadow:0 4px 10px rgba(11,96,214,0.15);}
    .chat-header-right{margin-left:auto;display:flex;align-items:center;gap:8px;}
    
    /* Side Menu CSS */
    .side-menu-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.3);
        z-index: 200;
        display: none;
        transition: opacity 0.3s;
        opacity: 0;
    }
    .side-menu {
        position: fixed;
        top: 0;
        right: 0;
        height: 100%;
        width: 80%; /* Adjust as needed */
        max-width: 320px;
        background: #fff;
        z-index: 210;
        box-shadow: -4px 0 16px rgba(0,0,0,0.15);
        transform: translateX(100%);
        transition: transform 0.3s ease-out;
        padding: 20px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
    }
    .side-menu.open {
        transform: translateX(0);
    }
    .side-menu-backdrop.visible {
        opacity: 1;
        display: block;
    }
    .side-menu-header {
        font-size: 20px;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        padding-bottom: 10px;
    }


    @media (min-width:900px){
      .phone{max-width:420px;margin:0 auto;box-shadow:0 20px 60px rgba(0,0,0,0.08);}
      .plus-menu{right:calc(50% - 210px);}
      .chat-input-area-wrapper{left:calc(50% - 210px);right:calc(50% - 210px);width:420px;bottom:64px;} 
    }
  
    /* Ensures chat input is always visible and bottom nav hidden in chat mode */
    .phone.chat-active .bottom-nav{ display:none !important; }
    .phone.chat-active .chat-input-area-wrapper{ bottom: 0 !important; z-index: 200; }
    .phone.chat-active .chat-messages{
      padding-bottom: calc(var(--input-area-height) + 12px) !important;
      /* ensure messages container size adapts */
    }
    /* Make sure chat-screen overlays do not get overlapped by other UI */
    .chat-screen{ z-index:160; position:relative; }

  
/* --- CHAT FIX: strong overlay, pinned input, prevent overlaps --- */
.individual-chat, .chat-screen {
  position: fixed !important;
  inset: 0 !important; /* top:0; right:0; bottom:0; left:0; */
  display: none !important;
  z-index: 9999 !important;
  background: var(--chat-bg, #fff) !important;
  -webkit-overflow-scrolling: touch;
  overflow: hidden !important;
}

/* messages container fills the remaining area above input */
.chat-messages {
  position: absolute !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 0 !important;
  overflow-y: auto !important;
  -webkit-overflow-scrolling: touch;
  padding: 16px !important;
  box-sizing: border-box !important;
}

/* pinned input wrapper */
.chat-input-area-wrapper {
  position: fixed !important;
  left: 16px !important;
  right: 16px !important;
  bottom: env(safe-area-inset-bottom, 12px) !important;
  z-index: 10010 !important;
  box-sizing: border-box;
  transition: bottom 150ms ease;
  pointer-events: auto;
}

/* make sure bottom nav and floating action button don't overlap when chat is open */
.phone.chat-active .bottom-nav,
.phone.chat-active .fab,
.phone.chat-active .floating-action {
  display: none !important;
  visibility: hidden !important;
  pointer-events: none !important;
}

/* Increase message bubble z-index if needed */
.chat-messages .message, .chat-messages .message:last-child {
  z-index: 10005;
}

/* ensure contact list cannot get above the chat overlay */
.contacts-list, .app-section, .main-list {
  z-index: 1;
}

/* if for any reason any element has pointer events that reach through, stop it */
.phone.chat-active *:not(.chat-input-area-wrapper):not(.chat-messages) {
  pointer-events: auto;
}

/* make sure floating add button has lower z than chat */
.fab { z-index: 1000 !important; }


/* Profile editor styles */
.profile-editor-modal {
  position: fixed;
  inset: 0;
  display: none;
  justify-content: center;
  align-items: center;
  background: rgba(0,0,0,0.45);
  z-index: 11000;
}
.profile-editor-card {
  width: 92%;
  max-width: 540px;
  background: white;
  border-radius: 14px;
  padding: 18px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.2);
  box-sizing: border-box;
  font-family: inherit;
}
.profile-editor-header { display:flex; align-items:center; gap:12px; margin-bottom:12px; }
.profile-avatar { width:78px; height:78px; border-radius:50%; background:linear-gradient(#e6f0ff,#dfeeff); display:flex; align-items:center; justify-content:center; font-size:34px; color:#1a73e8; position:relative; overflow:hidden; }
.profile-avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
.pencil-btn {
  background: #ffffffcc;
  border-radius: 50%;
  border: 1px solid rgba(0,0,0,0.06);
  padding:6px;
  position: absolute;
  right: -6px;
  bottom: -6px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.12);
  cursor:pointer;
}
.profile-row { margin-bottom:10px; }
.profile-row label{ display:block; font-size:13px; color:#666; margin-bottom:6px; }
.profile-row input, .profile-row textarea {
  width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e6eef9; font-size:15px; box-sizing:border-box;
  font-family: inherit;
}
.profile-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
.profile-actions button { padding:8px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
.save-btn { background: #0b66d6; color:white; }
.cancel-btn { background: #f1f5f9; color:#123; }

/* Delete contact button style for contact rows */
.contact-delete-btn {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:36px; height:36px;
  border-radius:50%;
  background:#fff;
  border:1px solid rgba(0,0,0,0.06);
  box-shadow: 0 6px 18px rgba(10,20,40,0.06);
  cursor:pointer;
  margin-left:8px;
  color:#d62828;
  font-weight:700;
  font-size:16px;
}
.contact-actions { display:flex; align-items:center; gap:8px; float:right; margin-right:8px; }
.small-pencil {
  display:inline-block;
  width:36px; height:36px; border-radius:50%; background:#0b66d6; color:white; text-align:center; line-height:36px; cursor:pointer;
  font-weight:700;
}

</style>
</head>
<body>
  <div class="phone">
    <div class="header" id="topHeader">
      <div class="logo"><img src="logo.png" alt="Zag Messenger Logo"></div>
      <div class="title">Zag Messenger</div>
      <!-- Added ID for easier targeting in JS for menu click -->
      <div class="menu" id="topHeaderMenu">☰</div>
    </div>

    <div class="wave-top" aria-hidden="true" id="waveTop">
      <svg viewBox="0 0 100 10" preserveAspectRatio="none"><path d="M0 5 C20 9,40 1,60 5 C80 9,100 3,100 3 L100 10 L0 10 Z"></path></svg>
    </div>

    <!-- Auth -->
    <div class="auth" id="auth-section">
      <div class="welcome">Welcome,<br>to Zag Messenger.</div>
      <div class="sub">Write your World</div>
      <input id="email" type="email" placeholder="Email">
      <div class="phone-group">
        <input class="country-code" value="+880" disabled>
        <input id="phoneNumber" type="tel" placeholder="Phone number">
      </div>
      <input id="password" type="password" placeholder="Password">

      <button id="authSubmitBtn" class="btn primary">Sign Up</button>

      <div class="toggle-btns">
        <button id="toSignIn" class="btn ghost">Already have an account? Sign In</button>
        <button id="toSignUp" class="btn ghost" style="display:none;">Don't have an account? Sign Up</button>
      </div>
    </div>

    <!-- Fixed List Header (My chats / Groups title) -->
    <!-- This will be hidden/shown by JS based on auth state and current view -->
    <div class="fixed-list-header" id="fixedListHeader" style="display:none;">
      <div class="top-controls">
        <h3 style="margin:0" id="list-title">My chats</h3>
        <div style="display:flex;gap:8px;align-items:center;">
          <div aria-hidden="true"></div>
        </div>
      </div>
    </div>

    <!-- App (Chats & Groups) -->
    <div class="app" id="app-section">
      <!-- Add -->
      <div id="add-chat-area">
        <div id="closeAddChat">×</div>
        <input id="addChatIdentifier" type="text" placeholder="Enter user email or phone">
        <button id="addChatBtn" class="btn primary">Add Person</button>
      </div>

      <!-- Lists -->
      <div id="chat-list-container"></div>
      <div id="group-list-container" style="display:none;"></div>
    </div>

    <!-- Chat Screen -->
    <div class="chat-screen" id="individual-chat-container">
      <div class="chat-header" role="banner" id="chatHeader">
        <div class="chat-header-left">
          <button id="backToChatListBtn" class="btn ghost" aria-label="Back to chats">&lt; Back</button>
        </div>

        <div class="chat-header-center" role="group" aria-label="Chat identity">
          <div id="current-chat-avatar" class="avatar"></div>
          <div class="chat-center-text">
            <div id="current-chat-name" class="chat-name" title=""></div>
            <div id="current-chat-sub" class="small"></div>
          </div>
        </div>

        <div class="chat-header-right" aria-hidden="false">
          <!-- Chat menu button with blue styling -->
          <button id="chatMenuBtn" class="chat-menu-btn" aria-label="Chat menu">⋮</button>
        </div>
      </div>

      <div id="chat-messages" class="chat-messages" role="log" aria-live="polite"></div>

      <!-- Message Input Bar - Transparent Background -->
      <div class="chat-input-area-wrapper" aria-label="Message input area">
        <div id="chat-input-area" class="chat-input">
          <input id="chatMessageInput" type="text" placeholder="Type a message..." aria-label="Type a message">
          <button id="sendChatMessageBtn" class="send-btn" aria-label="Send message">➤</button>
        </div>
      </div>
    </div>

    <div class="bottom-nav" id="bottom-nav">
      <span id="nav-home" class="active">Home</span>
      <span id="nav-groups">Groups</span>
      <span id="nav-games">Games</span>
      <span id="nav-you">@You</span>
    </div>

    <div class="floating-new" id="floatingNewBtn" title="Add new" style="display:none;">+</div>

    <div class="plus-menu" id="plusMenu">
      <button id="plusIndividualBtn">Individual Chat</button>
      <button id="plusGroupBtn">Group Chat</button>
    </div>
  </div>

  <!-- Side Menu HTML -->
  <div class="side-menu-backdrop" id="sideMenuBackdrop">
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header">Menu</div>
        <p style="color:var(--muted)">Content for the right-side menu will go here.</p>
        <p style="color:var(--muted)">Example menu items (Settings, Profile, etc.)</p>
    </div>
  </div>


  <!-- Group Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h4 id="modalTitle">New Group</h4>
      <div class="section-title">Group name</div>
      <input id="groupName" placeholder="Type group name..." />

      <div class="section-title">Add people (type email or phone and press Enter)</div>
      <input id="addMemberInput" placeholder="Email or phone" />

      <div class="section-title">Selected members</div>
      <div id="selectedMembers" style="min-height:40px;margin-bottom:8px;"></div>

      <div class="section-title">Contacts (tap to toggle)</div>
      <div class="contacts-list" id="contactsList"></div>

      <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
        <button id="cancelCreateGroup" class="btn ghost" style="width:auto;padding:8px 12px;">Cancel</button>
        <button id="createGroupBtn" class="btn primary" style="width:auto;padding:8px 12px;">Create Group</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js';
    import { getDatabase, ref as dbRef, set, get, onValue, push, update } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyBUH95hXYxMVCfhJglN4j3CReXy-CLYwmA',
      authDomain: 'live-messageinggkkh.firebaseapp.com',
      databaseURL: 'https://live-messageinggkkh-default-rtdb.firebaseio.com',
      projectId: 'live-messageinggkkh',
      storageBucket: 'live-messageinggkkh.appspot.com',
      messagingSenderId: '537475612761',
      appId: '1:537475612761:web:d00723c117383e54027148'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // DOM refs
    const authSection = document.getElementById('auth-section');
    const appSection = document.getElementById('app-section');
    const individualChat = document.getElementById('individual-chat-container');
    const floatingBtn = document.getElementById('floatingNewBtn');
    const plusMenu = document.getElementById('plusMenu');
    const addChatArea = document.getElementById('add-chat-area');
    const addChatIdentifier = document.getElementById('addChatIdentifier');
    const addBtn = document.getElementById('addChatBtn');
    const closeAdd = document.getElementById('closeAddChat');
    const chatList = document.getElementById('chat-list-container');
    const groupList = document.getElementById('group-list-container');
    const backBtn = document.getElementById('backToChatListBtn');
    const sendBtn = document.getElementById('sendChatMessageBtn');
    const msgInput = document.getElementById('chatMessageInput');
    const msgContainer = document.getElementById('chat-messages');
    const bottomNav = document.getElementById('bottom-nav');
    const authSubmitBtn = document.getElementById('authSubmitBtn');
    const email = document.getElementById('email');
    const pass = document.getElementById('password');
    const phone = document.getElementById('phoneNumber');
    const toSignIn = document.getElementById('toSignIn');
    const toSignUp = document.getElementById('toSignUp');
    const navHome = document.getElementById('nav-home');
    const navGroups = document.getElementById('nav-groups');
    const navGames = document.getElementById('nav-games');
    const navYou = document.getElementById('nav-you');
    const listTitle = document.getElementById('list-title');
    const welcomeText = document.querySelector('.welcome');
    const chatInputWrapper = document.querySelector('.chat-input-area-wrapper');
    const chatMenuBtn = document.getElementById('chatMenuBtn');
    const topHeaderMenu = document.getElementById('topHeaderMenu'); // New: Menu button

    const topHeader = document.getElementById('topHeader');
    const waveTop = document.getElementById('waveTop');
    const chatHeader = document.getElementById('chatHeader');
    const fixedListHeader = document.getElementById('fixedListHeader'); 
    
    // Side Menu DOM Refs
    const sideMenuBackdrop = document.getElementById('sideMenuBackdrop');
    const sideMenu = document.getElementById('sideMenu');

    // Modal refs
    const modalBackdrop = document.getElementById('modalBackdrop');
    const createGroupBtn = document.getElementById('createGroupBtn');
    const cancelCreateGroup = document.getElementById('cancelCreateGroup');
    const groupNameInput = document.getElementById('groupName');
    const addMemberInput = document.getElementById('addMemberInput');
    const selectedMembersDiv = document.getElementById('selectedMembers');
    const contactsListDiv = document.getElementById('contactsList');

    const plusIndividualBtn = document.getElementById('plusIndividualBtn');
    const plusGroupBtn = document.getElementById('plusGroupBtn');

    let currentChat = null;
    let currentUser = null;
    let usersCache = {};
    let selectedGroupMembers = {};
    let isSigningUp = true;

    // Side Menu Functions
    function openSideMenu() {
        sideMenuBackdrop.style.display = 'block';
        setTimeout(() => {
            sideMenuBackdrop.classList.add('visible');
            sideMenu.classList.add('open');
        }, 10);
    }

    function closeSideMenu() {
        sideMenuBackdrop.classList.remove('visible');
        sideMenu.classList.remove('open');
        setTimeout(() => {
            sideMenuBackdrop.style.display = 'none';
        }, 300); // Match CSS transition time
    }

    topHeaderMenu.addEventListener('click', openSideMenu);
    sideMenuBackdrop.addEventListener('click', (e) => {
        // Close if click is on the backdrop itself (not the menu)
        if (e.target === sideMenuBackdrop) {
            closeSideMenu();
        }
    });


    // show/hide top header + wave + fixed list header together and adjust content padding
    function setTopBannerVisible(visible) {
      const phoneEl = document.querySelector('.phone');
      if (visible) {
        topHeader.style.display = 'flex';
        waveTop.style.display = 'block';
        
        // fixedListHeader visibility is managed in updateUI for auth check
        
        // ensure phone content starts after header + wave
        phoneEl.style.paddingTop = 'calc(var(--header-height) + var(--wave-height))';
        
        // ensure chat header sits below header + wave
        chatHeader.style.top = 'calc(var(--header-height) + var(--wave-height))';
        
        // ensure chat-messages padding-top accounts for everything
        document.querySelectorAll('.chat-messages').forEach(cm => {
          cm.style.paddingTop = 'calc(var(--header-height) + var(--wave-height) + var(--header-height) + 12px)';
        });
      } else {
        // hide them on chat screens
        topHeader.style.display = 'none';
        waveTop.style.display = 'none';
        fixedListHeader.style.display = 'none'; // Ensure hidden on chat screen too
        
        phoneEl.style.paddingTop = '0px';
        
        // bring chat header to very top
        chatHeader.style.top = '0px';
        document.querySelectorAll('.chat-messages').forEach(cm => {
          cm.style.paddingTop = 'calc(var(--header-height) + 12px)';
        });
      }
    }

    // initial
    setTopBannerVisible(true);
    
    // Ensure bottom-nav is hidden and input stays visible when inside an individual chat.
    function enterChatMode(){
      const phoneEl = document.querySelector('.phone');
      if (phoneEl) phoneEl.classList.add('chat-active');
      if (bottomNav) bottomNav.style.display = 'none';
      if (chatInputWrapper) chatInputWrapper.style.bottom = '0px';
      // adjust messages padding so last message is not hidden
      if (msgContainer) msgContainer.style.paddingBottom = 'calc(var(--input-area-height) + 12px)';
    }
    function exitChatMode(){
      const phoneEl = document.querySelector('.phone');
      if (phoneEl) phoneEl.classList.remove('chat-active');
      if (bottomNav) bottomNav.style.display = 'flex';
      if (chatInputWrapper) chatInputWrapper.style.bottom = '64px';
      if (msgContainer) msgContainer.style.paddingBottom = '120px';
    }

    function updateAuthUI() {
      if (isSigningUp) {
        authSubmitBtn.textContent = 'Sign Up';
        welcomeText.innerHTML = 'Welcome,<br>to Zag Messenger.';
        if (phone && phone.parentElement) phone.parentElement.style.display = 'flex';
        toSignIn.style.display = 'block';
        toSignUp.style.display = 'none';
        authSubmitBtn.classList.add('primary');
        authSubmitBtn.classList.remove('ghost');
      } else {
        authSubmitBtn.textContent = 'Sign In';
        welcomeText.innerHTML = 'Welcome Back,<br>to Zag Messenger.';
        if (phone && phone.parentElement) phone.parentElement.style.display = 'none';
        toSignIn.style.display = 'none';
        toSignUp.style.display = 'block';
        authSubmitBtn.classList.add('primary');
        authSubmitBtn.classList.remove('ghost');
      }
    }
    toSignIn.addEventListener('click', () => { isSigningUp = false; updateAuthUI(); });
    toSignUp.addEventListener('click', () => { isSigningUp = true; updateAuthUI(); });
    updateAuthUI();

    async function createUserProfile(user) {
      if (!user) return;
      const userRef = dbRef(db, 'users/' + user.uid);
      const snap = await get(userRef);
      if (!snap.exists()) {
        await set(userRef, {
          email: user.email || '',
          uid: user.uid,
          phoneNumber: '+880' + (phone.value.trim() || '')
        });
      } else {
        const data = snap.val();
        if (!data.phoneNumber && phone.value.trim()) {
          await update(userRef, { phoneNumber: '+880' + phone.value.trim() });
        }
      }
    }

    authSubmitBtn.addEventListener('click', async () => {
      const e = (email.value || '').trim();
      const p = (pass.value || '').trim();
      const ph = (phone.value || '').trim();

      if (!e || !p) {
        return alert('Please enter email and password.');
      }
      if (isSigningUp && !ph) {
        return alert('Please enter your phone number for sign up.');
      }

      try {
        if (isSigningUp) {
          const userCredential = await createUserWithEmailAndPassword(auth, e, p);
          await createUserProfile(userCredential.user);
        } else {
          await signInWithEmailAndPassword(auth, e, p);
        }
      } catch (err) {
        alert((isSigningUp ? 'Sign up' : 'Sign in') + ' failed: ' + err.message);
        console.error(err);
      }
    });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        await createUserProfile(user);
        loadUsersCache();
        loadChats();
        loadGroups();
      }
      updateUI(user);
      updateFloatingVisibility();
    });

    function updateUI(user) {
      if (user) {
        authSection.style.display = 'none';
        appSection.style.display = 'block';
        individualChat.style.display = 'none';
        bottomNav.style.display = 'flex';
        navHome.classList.add('active');
        navGroups.classList.remove('active');
        listTitle.innerText = 'My chats';
        chatList.style.display = 'block';
        groupList.style.display = 'none';
        // show banner on list screens
        setTopBannerVisible(true);
        // UPDATED: Show fixed header only when signed in
        fixedListHeader.style.display = 'flex'; 
      } else {
        authSection.style.display = 'flex';
        appSection.style.display = 'none';
        individualChat.style.display = 'none';
        floatingBtn.style.display = 'none';
        bottomNav.style.display = 'flex';
        navHome.classList.remove('active');
        navGroups.classList.remove('active');
        setTopBannerVisible(true);
        // UPDATED: Hide fixed header on auth screen
        fixedListHeader.style.display = 'none'; 
      }
    }

    function updateFloatingVisibility() {
      const appVisible = appSection.style.display !== 'none';
      const chatVisible = individualChat.style.display !== 'none';
      // Only allow on 'Home' (My chats)
      const allowedNav = navHome.classList.contains('active'); 

      if (currentUser && appVisible && !chatVisible && allowedNav) {
        floatingBtn.style.display = 'flex';
      } else {
        floatingBtn.style.display = 'none';
        plusMenu.style.display = 'none';
      }
    }
    
    function loadUsersCache() {
      const usersRef = dbRef(db, 'users');
      onValue(usersRef, snap => {
        usersCache = {};
        contactsListDiv.innerHTML = '';
        snap.forEach(s => {
          const u = s.val();
          if (!u || !u.uid) return;
          usersCache[u.uid] = u;
          if (currentUser && u.uid !== currentUser.uid) {
            const div = document.createElement('div');
            div.className = 'contact-item';
            div.dataset.uid = u.uid;
            div.innerHTML = `<div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(180deg,#dbeeff,#c1ddff);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);">${(u.email||'U').charAt(0).toUpperCase()}</div>
                              <div style="flex:1;">
                                <div style="font-weight:700;color:var(--primary);font-size:14px;">${u.email || u.phoneNumber || 'Unknown'}</div>
                                <div class="small">${u.phoneNumber || ''}</div>
                              </div>`;
            div.addEventListener('click', () => {
              if (selectedGroupMembers[u.uid]) {
                delete selectedGroupMembers[u.uid];
                div.style.opacity = '1';
              } else {
                selectedGroupMembers[u.uid] = u;
                div.style.opacity = '0.6';
              }
              renderSelectedMembers();
            });
            contactsListDiv.appendChild(div);
          }
        });
      });
    }

    function renderSelectedMembers() {
      selectedMembersDiv.innerHTML = '';
      Object.values(selectedGroupMembers).forEach(u => {
        const span = document.createElement('span');
        span.style.display = 'inline-block';
        span.style.padding = '6px 10px';
        span.style.marginRight = '6px';
        span.style.background = '#f0f6ff';
        span.style.borderRadius = '999px';
        span.style.fontSize = '13px';
        span.textContent = u.email || u.phoneNumber || 'Member';
        selectedMembersDiv.appendChild(span);
      });
    }

    function escapeHtml(unsafe) {
      if (unsafe === undefined || unsafe === null) return '';
      return String(unsafe)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function formatTime(ms) {
      if (!ms) return '';
      const d = new Date(Number(ms));
      let hours = d.getHours();
      const minutes = d.getMinutes();
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      if (hours === 0) hours = 12;
      const mins = minutes < 10 ? '0' + minutes : minutes;
      return hours + ':' + mins + ' ' + ampm;
    }

    function shortenMiddle(str, maxLen = 28) {
      if (!str || str.length <= maxLen) return str;
      const atIdx = str.indexOf('@');
      if (atIdx > 0) {
        const domain = str.substring(atIdx);
        const keepLeft = Math.max(3, maxLen - domain.length - 3);
        const left = str.substring(0, keepLeft);
        return left + '...' + domain;
      }
      const leftKeep = Math.ceil((maxLen - 3) / 2);
      const rightKeep = Math.floor((maxLen - 3) / 2);
      return str.substring(0, leftKeep) + '...' + str.substring(str.length - rightKeep);
    }

    function loadChats() {
      chatList.innerHTML = '';
      if (!currentUser) {
        chatList.innerHTML = '<div class="small">Sign in to see chats.</div>';
        return;
      }
      const usersRef = dbRef(db, 'users');
      get(usersRef).then(snap => {
        if (!snap.exists()) {
          chatList.innerHTML = '<div class="small">No contacts yet.</div>';
          return;
        }
        chatList.innerHTML = '';
        snap.forEach(s => {
          const u = s.val();
          if (u.uid === currentUser.uid) return;
          const item = document.createElement('div');
          item.className = 'chat-item';
          item.dataset.uid = u.uid;
          item.innerHTML = `<div class="avatar">${(u.email||'U').charAt(0).toUpperCase()}</div>
                            <div class="chat-meta">
                              <div class="name">${u.email || u.phoneNumber || 'User'}</div>
                              <div class="sub">${u.phoneNumber || ''}</div>
                            </div>`;
          item.addEventListener('click', () => {
            openPrivateChatWith(u);
          });
          chatList.appendChild(item);
        });
      }).catch(err => {
        console.error('loadChats error', err);
        chatList.innerHTML = '<div class="small">Error loading chats.</div>';
      });
    }

    function scrollLatestMessageIntoView(behavior = 'auto') {
      const last = msgContainer.lastElementChild;
      if (!last) return;
      try {
        last.scrollIntoView({ behavior, block: 'end', inline: 'nearest' });
      } catch (e) {
        msgContainer.scrollTop = msgContainer.scrollHeight;
      }
    }

    function openPrivateChatWith(userObj) {
      if (!currentUser) return alert('Not signed in');
      const chatId = [currentUser.uid, userObj.uid].sort().join('_');
      currentChat = { type: 'private', id: chatId, with: userObj };

      document.getElementById('current-chat-avatar').textContent = (userObj.email||'U').charAt(0).toUpperCase();
      const displayName = userObj.email || userObj.phoneNumber || 'User';
      const short = shortenMiddle(displayName, 28);
      const nameEl = document.getElementById('current-chat-name');
      nameEl.textContent = short;
      nameEl.title = displayName;
      document.getElementById('current-chat-sub').textContent = userObj.phoneNumber || '';

      appSection.style.display = 'none';
      individualChat.style.display = 'flex';
      msgContainer.innerHTML = '';

      // hide top banner (header + wave + fixed list header) on chat screen
      setTopBannerVisible(false);
      updateFloatingVisibility();
      // ensure chat input stays visible and bottom nav hidden
      enterChatMode();

      const messagesRef = dbRef(db, 'messages/' + chatId);
      onValue(messagesRef, snap => {
        msgContainer.innerHTML = '';
        snap.forEach(child => {
          const m = child.val();
          const isSent = m.sender === currentUser.uid;
          const div = document.createElement('div');
          div.className = 'bubble ' + (isSent ? 'sent' : 'received');
          div.innerHTML = `<div>${escapeHtml(m.text)}</div>
                           <div class="msg-meta">${formatTime(m.timestamp)}</div>`;
          msgContainer.appendChild(div);
        });
        scrollLatestMessageIntoView();
      });
    }

    function openGroupChat(groupObj) {
      if (!currentUser) return alert('Not signed in');
      currentChat = { type: 'group', id: groupObj.id, group: groupObj };
      document.getElementById('current-chat-avatar').textContent = (groupObj.name||'G').charAt(0).toUpperCase();
      const groupName = groupObj.name || 'Group';
      const short = shortenMiddle(groupName, 28);
      const nameEl = document.getElementById('current-chat-name');
      nameEl.textContent = short;
      nameEl.title = groupName;
      document.getElementById('current-chat-sub').textContent = (Object.keys(groupObj.members||{}).length || 0) + ' members';

      appSection.style.display = 'none';
      individualChat.style.display = 'flex';
      msgContainer.innerHTML = '';

      // hide top banner on chat screen
      setTopBannerVisible(false);
      updateFloatingVisibility();
      // ensure chat input stays visible and bottom nav hidden
      enterChatMode();

      const messagesRef = dbRef(db, 'messages/' + groupObj.id);
      onValue(messagesRef, snap => {
        msgContainer.innerHTML = '';
        snap.forEach(child => {
          const m = child.val();
          const isSent = m.sender === currentUser.uid;
          const div = document.createElement('div');
          div.className = 'bubble ' + (isSent ? 'sent' : 'received');

          let senderLabel = '';
          if (!isSent) {
            const sender = usersCache[m.sender];
            if (sender) senderLabel = escapeHtml(sender.email || sender.phoneNumber || 'Member');
            else senderLabel = 'Member';
          }

          div.innerHTML = `<div style="font-weight:700;font-size:13px;margin-bottom:6px;">${senderLabel}</div>
                           <div>${escapeHtml(m.text)}</div>
                           <div class="msg-meta">${formatTime(m.timestamp)}</div>`;
          msgContainer.appendChild(div);
        });
        scrollLatestMessageIntoView();
      });
    }

    backBtn.addEventListener('click', () => {
      individualChat.style.display = 'none';
      appSection.style.display = 'block';
      currentChat = null;
      // show top banner when returning to list
      setTopBannerVisible(true);
      // restore bottom nav and input positioning
      exitChatMode();
      updateFloatingVisibility();
    });

    sendBtn.addEventListener('click', async () => {
      const text = (msgInput.value || '').trim();
      if (!text) return;
      if (!currentChat) return alert('Open a chat first.');
      const chatId = currentChat.id;
      const messagesRef = dbRef(db, 'messages/' + chatId);
      const newMsgRef = push(messagesRef);
      await set(newMsgRef, {
        text,
        sender: currentUser.uid,
        senderEmail: currentUser.email || '',
        timestamp: Date.now()
      });
      msgInput.value = '';
      setTimeout(() => scrollLatestMessageIntoView('smooth'), 120);
    });

    msgInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // Ensure + button functionality is working
    floatingBtn.addEventListener('click', (e) => {
      if (plusMenu.style.display === 'flex') {
        plusMenu.style.display = 'none';
      } else {
        plusMenu.style.display = 'flex';
        setTimeout(() => { plusMenu.style.display = 'none'; }, 6000);
      }
    });

    plusIndividualBtn.addEventListener('click', () => {
      plusMenu.style.display = 'none';
      addChatArea.style.display = 'block';
      addChatIdentifier.focus();
      updateFloatingVisibility();
    });
    plusGroupBtn.addEventListener('click', () => {
      plusMenu.style.display = 'none';
      modalBackdrop.style.display = 'flex';
    });

    closeAdd.addEventListener('click', () => {
      addChatArea.style.display = 'none';
      updateFloatingVisibility();
    });

    addBtn.addEventListener('click', async () => {
      const val = (addChatIdentifier.value || '').trim();
      if (!val) return alert('Enter email or phone to add.');
      const usersRef = dbRef(db, 'users');
      const snapshot = await get(usersRef);
      let found = null;
      snapshot.forEach(s => {
        const u = s.val();
        if (!u) return;
        if (u.email === val || u.phoneNumber === val || ('+880'+val) === u.phoneNumber) {
          found = u;
        }
      });
      if (!found) {
        return alert('User not found in directory. They must sign up first.');
      }
      openPrivateChatWith(found);
      addChatArea.style.display = 'none';
      addChatIdentifier.value = '';
      updateFloatingVisibility();
    });

    navGroups.addEventListener('click', () => {
      navGroups.classList.add('active');
      navHome.classList.remove('active');
      listTitle.innerText = 'Groups';
      chatList.style.display = 'none';
      groupList.style.display = 'block';
      updateFloatingVisibility();
      loadGroups();
    });
    navHome.addEventListener('click', () => {
      navHome.classList.add('active');
      navGroups.classList.remove('active');
      listTitle.innerText = 'My chats';
      chatList.style.display = 'block';
      groupList.style.display = 'none';
      updateFloatingVisibility();
      loadChats();
    });

    cancelCreateGroup.addEventListener('click', () => {
      modalBackdrop.style.display = 'none';
      updateFloatingVisibility();
    });
    addMemberInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        const q = (addMemberInput.value || '').trim();
        if (!q) return;
        let found = null;
        Object.values(usersCache).forEach(u => {
          if (u.email === q || u.phoneNumber === q || ('+880'+q) === u.phoneNumber) found = u;
        });
        if (found) {
          selectedGroupMembers[found.uid] = found;
          renderSelectedMembers();
          addMemberInput.value = '';
        } else {
          alert('User not found');
        }
      }
    });

    createGroupBtn.addEventListener('click', async () => {
      const name = (groupNameInput.value || '').trim();
      if (!name) return alert('Enter group name');
      const memberUids = Object.keys(selectedGroupMembers);
      if (memberUids.length === 0) return alert('Add at least one member');
      const groupsRef = dbRef(db, 'groups');
      const newGroupRef = push(groupsRef);
      const groupId = newGroupRef.key;
      const groupData = {
        id: groupId,
        name,
        members: { [currentUser.uid]: true },
        createdAt: Date.now(),
        createdBy: currentUser.uid
      };
      memberUids.forEach(uid => groupData.members[uid] = true);
      await set(newGroupRef, groupData);
      modalBackdrop.style.display = 'none';
      groupNameInput.value = '';
      selectedGroupMembers = {};
      renderSelectedMembers();
      alert('Group created');
      loadGroups();
      updateFloatingVisibility();
    });

    function loadGroups() {
      groupList.innerHTML = '';
      if (!currentUser) {
        groupList.innerHTML = '<div class="small">Sign in to see groups.</div>';
        return;
      }
      const groupsRef = dbRef(db, 'groups');
      get(groupsRef).then(snap => {
        groupList.innerHTML = '';
        if (!snap.exists()) return;
        snap.forEach(s => {
          const g = s.val();
          if (!g || !g.members) return;
          if (g.members[currentUser.uid]) {
            const div = document.createElement('div');
            div.className = 'chat-item';
            div.innerHTML = `<div class="avatar">G</div>
                             <div class="chat-meta">
                               <div class="name">${g.name}</div>
                               <div class="sub">${Object.keys(g.members).length} members</div>
                             </div>`;
            div.addEventListener('click', () => {
              openGroupChat(g);
            });
            groupList.appendChild(div);
          }
        });
      }).catch(err => {
        console.error('loadGroups error', err);
        groupList.innerHTML = '<div class="small">Error loading groups.</div>';
      });
    }

    navYou.addEventListener('click', async () => {
      if (!currentUser) return alert('Not signed in');
      const ok = confirm('Sign out?');
      if (ok) {
        await signOut(auth);
      }
    });

    window.addEventListener('resize', updateFloatingVisibility);
    window.addEventListener('focus', updateFloatingVisibility);

    (function setupKeyboardAwareInput() {
      const chatWrapper = chatInputWrapper;

      function computeTargetBottom() {
        const baseBottom = 64;
        const maxExtra = 6;
        if (window.visualViewport) {
          const vhDiff = window.innerHeight - window.visualViewport.height;
          const extra = Math.max(0, Math.min(maxExtra, vhDiff));
          return baseBottom + extra;
        }
        return baseBottom + 28;
      }

      function onFocusAdjust() {
        const target = computeTargetBottom();
        chatWrapper.style.bottom = target + 'px';
        chatWrapper.classList.add('keyboard-open');
        try { scrollLatestMessageIntoView(); } catch(e){}
      }

      function onBlurReset() {
        setTimeout(() => {
          chatWrapper.style.bottom = '64px';
          chatWrapper.classList.remove('keyboard-open');
        }, 120);
      }

      msgInput.addEventListener('focus', onFocusAdjust);
      msgInput.addEventListener('blur', onBlurReset);

      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', () => {
          if (document.activeElement === msgInput) {
            onFocusAdjust();
          }
        });
      }

      window.addEventListener('orientationchange', () => {
        setTimeout(() => { chatWrapper.style.bottom = '64px'; }, 400);
      });
    })();

    document.addEventListener('click', (e) => {
      const id = e.target && e.target.id;
      if (id === 'closeMainModal') {
        document.querySelector('.phone').classList.remove('blurred-bg');
        const m = document.getElementById('mainModalBackdrop');
        if (m) m.style.display = 'none';
      } else if (id === 'openIndividualModalBtn') {
        document.querySelector('.phone').classList.remove('blurred-bg');
        const m = document.getElementById('mainModalBackdrop');
        if (m) m.style.display = 'none';
        addChatArea.style.display = 'block';
        addChatIdentifier.focus();
      } else if (id === 'openGroupModalBtn') {
        document.querySelector('.phone').classList.remove('blurred-bg');
        const m = document.getElementById('mainModalBackdrop');
        if (m) m.style.display = 'none';
        modalBackdrop.style.display = 'flex';
      }
    });

    floatingBtn.addEventListener('dblclick', () => {
      const main = document.getElementById('mainModalBackdrop');
      if (main) {
        document.querySelector('.phone').classList.add('blurred-bg');
        main.style.display = 'flex';
      }
    });

    if (chatMenuBtn) {
      chatMenuBtn.addEventListener('click', () => {
        alert('Chat menu (⋮) clicked — implement actions as needed.');
      });
    }

    window.addEventListener('load', () => {
      // Show the fixed list header when the app is initialized and user is logged in
      const flh = document.getElementById('fixedListHeader');
      if (flh && appSection.style.display !== 'none' && currentUser) flh.style.display = 'flex';
      // If the page was reloaded while in a chat, ensure UI is consistent
      if (document.querySelector('.phone.chat-active')){
        if (bottomNav) bottomNav.style.display = 'none';
      }
    });

    console.log('User fixes applied: scroll position adjusted, side menu implemented, fixed header visibility fixed on auth page.');
  </script>

  <!-- Main + Modal -->
  <div class="main-modal-backdrop" id="mainModalBackdrop" style="display:none;">
    <div class="main-modal" style="width:90%;max-width:420px;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;border-radius:16px;padding:24px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.2);position:relative;">
      <div class="close-modal" id="closeMainModal" style="position:absolute;top:10px;right:14px;background:#fff;color:var(--primary);border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-weight:bold;">×</div>
      <h3 style="margin:0 0 20px;font-size:20px;">Start New Chat</h3>
      <button id="openIndividualModalBtn" style="display:block;width:100%;padding:12px;margin:10px 0;border:none;border-radius:10px;background:#fff;color:var(--primary);font-weight:700;">Individual Chat</button>
      <button id="openGroupModalBtn" style="display:block;width:100%;padding:12px;margin:10px 0;border:none;border-radius:10px;background:#fff;color:var(--primary);font-weight:700;">Group Chat</button>
    </div>
  </div>

<script>
// --- CHAT FIX JS ---
(function(){
  // helper elements (try to find common ids/classnames used in the app)
  const phone = document.querySelector('.phone') || document.body;
  const bottomNav = document.querySelector('.bottom-nav');
  const fab = document.querySelector('.fab') || document.querySelector('.floating-action') || null;
  const chatWrapper = document.querySelector('.individual-chat') || document.querySelector('.chat-screen');
  const msgContainer = document.querySelector('.chat-messages') || document.querySelector('#msgContainer') || null;
  const chatInputWrapper = document.querySelector('.chat-input-area-wrapper') || document.querySelector('.chat-input') || null;

  // Ensure functions exist (if earlier code created them, don't override - but provide improved versions)
  window.enterChatMode = window.enterChatMode || function(){
    if (phone) phone.classList.add('chat-active');
    if (chatWrapper) chatWrapper.style.display = 'flex';
    if (bottomNav) bottomNav.style.display = 'none';
    if (fab) fab.style.display = 'none';
    // force input to bottom
    if (chatInputWrapper) {
      chatInputWrapper.style.bottom = 'env(safe-area-inset-bottom, 8px)';
      chatInputWrapper.style.position = 'fixed';
    }
    // reserve padding for messages so last message is visible
    if (msgContainer) {
      const h = chatInputWrapper ? chatInputWrapper.offsetHeight : 80;
      msgContainer.style.paddingBottom = (h + 24) + 'px';
      // scroll to bottom
      setTimeout(()=>{ try{ msgContainer.scrollTop = msgContainer.scrollHeight; }catch(e){} }, 120);
    }
    // adjust for keyboard if available
    adjustForKeyboard();
  };

  window.exitChatMode = window.exitChatMode || function(){
    if (phone) phone.classList.remove('chat-active');
    if (chatWrapper) chatWrapper.style.display = 'none';
    if (bottomNav) bottomNav.style.display = '';
    if (fab) fab.style.display = '';
    if (chatInputWrapper) {
      chatInputWrapper.style.bottom = 'env(safe-area-inset-bottom, 12px)';
    }
    if (msgContainer) msgContainer.style.paddingBottom = '';
  };

  // If visualViewport available, adjust input position when keyboard opens on mobile browsers
  function adjustForKeyboard(){
    try{
      const vv = window.visualViewport;
      if (!chatInputWrapper) return;
      if (vv){
        // number of pixels the viewport lost from window.innerHeight
        const keyboardHeight = Math.max(0, window.innerHeight - vv.height - (vv.offsetTop || 0));
        // Add safe area inset
        const safeInset = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-inset-bottom') || 0) || 0;
        // set bottom to keyboardHeight to push input above keyboard (plus small offset)
        chatInputWrapper.style.bottom = (keyboardHeight + 8) + 'px';
        // increase padding bottom of messages so last message not hidden
        if (msgContainer){
          const h = chatInputWrapper.offsetHeight + keyboardHeight + 8;
          msgContainer.style.paddingBottom = h + 'px';
          // keep scroll at bottom
          setTimeout(()=>{ try{ msgContainer.scrollTop = msgContainer.scrollHeight; }catch(e){} }, 50);
        }
      } else {
        // fallback
        chatInputWrapper.style.bottom = 'env(safe-area-inset-bottom, 12px)';
        if (msgContainer) {
          msgContainer.style.paddingBottom = (chatInputWrapper.offsetHeight + 24) + 'px';
        }
      }
    }catch(e){
      console.warn('adjustForKeyboard error', e);
    }
  }

  // attach listeners
  if (window.visualViewport){
    window.visualViewport.addEventListener('resize', adjustForKeyboard);
    window.visualViewport.addEventListener('scroll', adjustForKeyboard);
  }
  window.addEventListener('resize', adjustForKeyboard);
  window.addEventListener('orientationchange', adjustForKeyboard);

  // When input inside chat gets focus (user opens keyboard), adjust right away
  document.addEventListener('focusin', (ev)=>{
    if (chatInputWrapper && chatInputWrapper.contains(ev.target)) {
      setTimeout(adjustForKeyboard, 60);
    }
  });
  document.addEventListener('focusout', (ev)=>{
    if (chatInputWrapper && chatInputWrapper.contains(ev.target)) {
      setTimeout(()=>{
        // restore
        chatInputWrapper.style.bottom = 'env(safe-area-inset-bottom, 12px)';
        if (msgContainer) msgContainer.style.paddingBottom = (chatInputWrapper.offsetHeight + 24) + 'px';
      }, 60);
    }
  });

  // Safety: when opening any chat list item, force-enter chat mode (for inconsistent existing handlers)
  document.addEventListener('click', (ev)=>{
    const row = ev.target.closest && ev.target.closest('.contact-row, .list-item, .user-row, .person-row');
    if (row){
      // small delay so original click handler runs then we enforce chat mode
      setTimeout(()=>{
        if (document.querySelector('.individual-chat') && document.querySelector('.individual-chat').style.display !== 'none'){
          window.enterChatMode();
        }
      }, 80);
    }
  });

  // Expose adjustForKeyboard for debugging
  window.__adjustChatForKeyboard = adjustForKeyboard;

  // if we are already inside a chat when page loads, enter chat mode now
  if (document.querySelector('.individual-chat') && document.querySelector('.individual-chat').style.display !== 'none'){
    window.enterChatMode();
  }
})();
</script>

<!-- Profile editor modal -->
<div id="profileEditorModal" class="profile-editor-modal" aria-hidden="true">
  <div class="profile-editor-card" role="dialog" aria-modal="true">
    <div class="profile-editor-header">
      <div class="profile-avatar" id="profileAvatar">
        <span id="profileInitial">Y</span>
        <button class="pencil-btn" id="avatarChangeBtn" title="Change photo">✎</button>
      </div>
      <div style="flex:1;">
        <div style="font-weight:700; font-size:18px;" id="profileEmailDisplay">you@example.com</div>
        <div style="font-size:13px; color:#567; margin-top:4px;">Handle name is your email (cannot change)</div>
      </div>
    </div>

    <div class="profile-row">
      <label for="profileNameInput">Display name</label>
      <input id="profileNameInput" type="text" placeholder="Your display name">
    </div>

    <div class="profile-row">
      <label for="profileAboutInput">About</label>
      <textarea id="profileAboutInput" rows="3" placeholder="Write something about yourself..."></textarea>
    </div>

    <div style="display:none;">
      <input id="profileImageFile" type="file" accept="image/*">
    </div>

    <div class="profile-actions">
      <button class="cancel-btn" id="profileCancelBtn">Cancel</button>
      <button class="save-btn" id="profileSaveBtn">Save</button>
    </div>
  </div>
</div>

<script>
(function(){
  // Utility: find '@You' element(s) by text
  function findYouElements(){
    const els = Array.from(document.querySelectorAll('button, a, div, span, li')).filter(el=>el.innerText && el.innerText.trim().includes('@You'));
    return els;
  }

  // Detect an email present on the page (try to find logged-in email)
  function detectMyEmail(){
    // try known global variable
    try{ if(window.currentUser && typeof window.currentUser === 'string' && window.currentUser.includes('@')) return window.currentUser; }catch(e){}
    // try meta or profile area
    const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/;
    const allText = document.body.innerText;
    const m = allText.match(emailRegex);
    if(m) return m[0];
    return ''; // fallback empty
  }

  function loadProfile(){
    const stored = localStorage.getItem('myProfile_v1');
    if(stored) return JSON.parse(stored);
    // default profile with detected email
    const email = detectMyEmail() || 'you@example.com';
    const p = { email: email, name: '', about: '', avatar: '' };
    localStorage.setItem('myProfile_v1', JSON.stringify(p));
    return p;
  }
  function saveProfile(p){
    localStorage.setItem('myProfile_v1', JSON.stringify(p));
    applyProfileToUI(p);
    // update contacts list: if contact row with same email exists, update its visible name
    updateContactNameInList(p.email, p.name);
  }

  function applyProfileToUI(p){
    const emailEl = document.getElementById('profileEmailDisplay');
    const initialEl = document.getElementById('profileInitial');
    const avatarEl = document.getElementById('profileAvatar');
    if(emailEl) emailEl.innerText = p.email;
    if(p.avatar && avatarEl){
      avatarEl.innerHTML = '<img src="'+p.avatar+'" alt="avatar">';
    } else {
      if(initialEl) initialEl.innerText = (p.name && p.name.trim().length>0) ? p.name.trim()[0].toUpperCase() : (p.email ? p.email[0].toUpperCase() : 'Y');
    }
    // also update any small @You display if exists
    const youEls = findYouElements();
    youEls.forEach(el=>{
      // show small pencil near it
      if(!el.querySelector('.small-pencil')){
        const sp = document.createElement('span');
        sp.className = 'small-pencil';
        sp.title = 'Edit profile';
        sp.innerText = '✎';
        sp.style.marginLeft = '8px';
        sp.addEventListener('click', (ev)=>{ ev.stopPropagation(); openProfileEditor(); });
        el.appendChild(sp);
      }
    });
  }

  function openProfileEditor(){
    const modal = document.getElementById('profileEditorModal');
    const profile = loadProfile();
    if(!modal) return;
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
    // populate fields
    document.getElementById('profileEmailDisplay').innerText = profile.email;
    document.getElementById('profileNameInput').value = profile.name || '';
    document.getElementById('profileAboutInput').value = profile.about || '';
    // avatar
    if(profile.avatar){
      document.getElementById('profileAvatar').innerHTML = '<img src="'+profile.avatar+'"> <button class="pencil-btn" id="avatarChangeBtn" title="Change photo">✎</button>';
      // rebind change btn
      const changeBtn = document.getElementById('avatarChangeBtn');
      if(changeBtn) changeBtn.addEventListener('click', ()=> document.getElementById('profileImageFile').click());
    } else {
      document.getElementById('profileAvatar').innerHTML = '<span id="profileInitial">'+(profile.name?profile.name[0].toUpperCase(): (profile.email?profile.email[0].toUpperCase():'Y'))+'</span><button class="pencil-btn" id="avatarChangeBtn" title="Change photo">✎</button>';
      const changeBtn = document.getElementById('avatarChangeBtn');
      if(changeBtn) changeBtn.addEventListener('click', ()=> document.getElementById('profileImageFile').click());
    }
  }

  function closeProfileEditor(){
    const modal = document.getElementById('profileEditorModal');
    if(!modal) return;
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }

  // When avatar file selected, convert to base64 and preview
  document.addEventListener('change', (ev)=>{
    if(ev.target && ev.target.id === 'profileImageFile' && ev.target.files && ev.target.files[0]){
      const f = ev.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e){
        const data = e.target.result;
        const p = loadProfile();
        p.avatar = data;
        saveProfile(p);
        // refresh editor UI if open
        openProfileEditor();
      };
      reader.readAsDataURL(f);
    }
  });

  // Save/Cancel handlers
  document.addEventListener('click', (ev)=>{
    if(ev.target && ev.target.id === 'profileSaveBtn'){
      const p = loadProfile();
      p.name = document.getElementById('profileNameInput').value || '';
      p.about = document.getElementById('profileAboutInput').value || '';
      saveProfile(p);
      closeProfileEditor();
    }
    if(ev.target && ev.target.id === 'profileCancelBtn'){
      closeProfileEditor();
    }
    // close modal when clicking outside the card
    if(ev.target && ev.target.id === 'profileEditorModal'){
      closeProfileEditor();
    }
  });

  // Update contact name in list if an element shows the email
  function updateContactNameInList(email, newName){
    if(!email) return;
    // find elements containing this email text and try to update their parent row title
    const els = Array.from(document.querySelectorAll('*')).filter(el=> el.children.length>0 && el.innerText && el.innerText.includes(email));
    els.forEach(el=>{
      // try to find a sibling or element within el which is the name display (commonly large text)
      const candidate = Array.from(el.querySelectorAll('div, span, p, h3')).find(x=> x.innerText && x.innerText !== email && x.innerText.trim().length>0);
      if(candidate){
        candidate.innerText = newName || email;
      } else {
        // fallback: if el itself looks like email container, set previous sibling text
        if(el.previousElementSibling){
          el.previousElementSibling.innerText = newName || email;
        }
      }
    });
  }

  // Add delete buttons to contact rows: find rows that contain an email and append a delete button
  function addDeleteButtonsToContacts(){
    const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/;
    // find item nodes that look like contact rows: have an email inside and are visible
    const allNodes = Array.from(document.querySelectorAll('div, li, article, section')).filter(n=> n.innerText && emailRegex.test(n.innerText));
    allNodes.forEach(node=>{
      if(node.querySelector('.contact-delete-btn')) return; // already has delete
      const m = node.innerText.match(emailRegex);
      if(!m) return;
      const email = m[0];
      // create actions container
      let actions = node.querySelector('.contact-actions');
      if(!actions){
        actions = document.createElement('div');
        actions.className = 'contact-actions';
        // append to node (try different spots)
        node.style.position = 'relative';
        node.appendChild(actions);
      }
      const del = document.createElement('button');
      del.className = 'contact-delete-btn';
      del.title = 'Delete contact';
      del.innerText = '×';
      del.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        // remove the node from DOM
        node.remove();
        // optionally remove from localStorage contacts array if stored
        try{
          const stored = localStorage.getItem('contacts_v1');
          if(stored){
            const arr = JSON.parse(stored);
            const filtered = arr.filter(c=> c.email !== email);
            localStorage.setItem('contacts_v1', JSON.stringify(filtered));
          }
        }catch(e){}
      });
      actions.appendChild(del);
    });
  }

  // Expose openProfileEditor to global so other code can call it
  window.openProfileEditor = openProfileEditor;

  // When '@You' elements are clicked, open profile editor
  function bindYouClicks(){
    const youEls = findYouElements();
    youEls.forEach(el=>{
      el.addEventListener('click', (ev)=>{
        ev.preventDefault();
        openProfileEditor();
      });
      // add pencil small icon if not present
      if(!el.querySelector('.small-pencil')){
        const sp = document.createElement('span');
        sp.className = 'small-pencil';
        sp.title = 'Edit profile';
        sp.innerText = '✎';
        sp.style.marginLeft = '8px';
        sp.addEventListener('click', (ev)=>{ ev.stopPropagation(); openProfileEditor(); });
        el.appendChild(sp);
      }
    });
  }

  // Initialize on page load
  window.addEventListener('load', ()=>{
    try{
      const profile = loadProfile();
      applyProfileToUI(profile);
      bindYouClicks();
      addDeleteButtonsToContacts();
      // run again after short delay to catch dynamically loaded contacts
      setTimeout(()=>{ addDeleteButtonsToContacts(); bindYouClicks(); }, 900);
    }catch(e){ console.warn('profile editor init failed', e); }
  });

  // Public: deleteContact(email)
  window.deleteContactByEmail = function(email){
    if(!email) return;
    // find first node containing that email and remove it
    const node = Array.from(document.querySelectorAll('*')).find(n=> n.innerText && n.innerText.includes(email) && n.children.length>0);
    if(node) node.remove();
    // update stored contacts array if present
    try{
      const stored = localStorage.getItem('contacts_v1');
      if(stored){
        const arr = JSON.parse(stored);
        const filtered = arr.filter(c=> c.email !== email);
        localStorage.setItem('contacts_v1', JSON.stringify(filtered));
      }
    }catch(e){}
  };
})(); 
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Messaging App</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#f5f5f5;min-height:100vh;display:flex;justify-content:center;align-items:flex-start}
    .container{width:100%;max-width:520px;background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.08);box-sizing:border-box;margin:12px}
    h2{text-align:center;margin:6px 0 12px}
    h3{margin:14px 0 8px}
    input,button,textarea{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;font-size:15px}
    button{background:#007bff;color:#fff;border:none;cursor:pointer;font-weight:600}
    button:disabled{background:#ccc;cursor:not-allowed}
    .message{padding:8px;border-radius:6px;margin:8px 0}
    .success{background:#e6ffef;color:#0b6623;border:1px solid #c9f3d6}
    .error{background:#ffecec;color:#8b1a1a;border:1px solid #f5c6c6}
    .info{background:#eef6ff;color:#0b3a66;border:1px solid #cfe6ff}
    /* Horizontal posts gallery */
    #posts-scroll-container{display:flex;overflow-x:auto;gap:10px;padding:6px 0;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;touch-action:pan-x}
    #posts-scroll-container::-webkit-scrollbar{height:6px}
    #posts-scroll-container::-webkit-scrollbar-thumb{background:#bbb;border-radius:3px}
    .post-card{flex:0 0 auto;width:180px;height:180px;overflow:hidden;border-radius:8px;background:#eee;display:flex;align-items:center;justify-content:center}
    .post-card img{width:100%;height:100%;object-fit:cover;display:block}
    .chat-list-item{display:flex;align-items:center;padding:10px;background:#f0f2f5;margin:6px 0;border-radius:8px;cursor:pointer}
    .chat-list-avatar{width:40px;height:40px;border-radius:50%;background:#007bff;color:#fff;display:flex;align-items:center;justify-content:center;margin-right:10px;font-weight:700}
    #individual-chat-container{display:none;flex-direction:column;border:1px solid #eee;padding:10px;border-radius:8px;margin-top:8px;background:#fafafa;height:60vh;min-height:360px}
    #chat-messages{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:6px;padding-right:6px}
    .chat-message{padding:8px 12px;border-radius:14px;max-width:78%;line-height:1.4;word-wrap:break-word}
    .chat-message.sent{background:#007bff;color:#fff;align-self:flex-end;margin-left:auto}
    .chat-message.received{background:#e8eaf0;color:#111;align-self:flex-start;margin-right:auto}
    #chat-input-area{display:flex;gap:8px;margin-top:8px}
    #chat-input-area input{flex:1;margin:0}
    @media(max-width:420px){.post-card{width:140px;height:140px}}
  </style>
</head>
<body>
  <div class="container">
    <h2>Live Messaging App</h2>

    <div id="auth-section">
      <div id="auth-message-area"></div>
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <button id="signupBtn">Sign Up</button>
      <button id="loginBtn">Sign In</button>
    </div>

    <div id="app-section" style="display:none">
      <h3>Upload Post</h3>
      <input id="postImage" type="file" accept="image/*" />
      <button id="uploadPostBtn">Upload</button>
      <div id="post-message-area"></div>

      <h3>Posts</h3>
      <div id="no-posts-message">No posts yet.</div>
      <div id="posts-scroll-container" aria-live="polite"></div>

      <hr>

      <h3>My Chats</h3>
      <div id="chat-management-area">
        <div id="chat-message-area"></div>
        <input id="addChatEmail" type="email" placeholder="Enter user's email to chat" />
        <button id="addChatBtn">Add Person to Chat</button>
      </div>

      <div id="no-chats-message">No active chats. Add someone to start chatting!</div>
      <div id="chat-list-container"></div>

      <div id="individual-chat-container">
        <div id="chat-header" style="display:flex;align-items:center;gap:8px;padding-bottom:8px;border-bottom:1px solid #eee;margin-bottom:8px">
          <button id="backToChatListBtn" style="padding:6px 10px">&lt; Back</button>
          <div id="current-chat-avatar" class="chat-list-avatar"></div>
          <h4 id="current-chat-name" style="margin:0"></h4>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input-area">
          <input id="chatMessageInput" type="text" placeholder="Type a message..." />
          <button id="sendChatMessageBtn">Send</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { getDatabase, ref, push, onValue, set, query, orderByChild, equalTo, get, onChildAdded } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUH95hXYxMVCfhJglN4j3CReXy-CLYwmA",
      authDomain: "live-messageinggkkh.firebaseapp.com",
      databaseURL: "https://live-messageinggkkh-default-rtdb.firebaseio.com",
      projectId: "live-messageinggkkh",
      storageBucket: "live-messageinggkkh.appspot.com",
      messagingSenderId: "537475612761",
      appId: "1:537475612761:web:d00723c117383e54027148"
    };

    const IMGBB_API_KEY = "dd99dd6508ecaf9c5a78e1d20a234937";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const postsRef = ref(db, 'posts');
    const usersRef = ref(db, 'users');
    const chatsRef = ref(db, 'chats');
    const privateMessagesRoot = ref(db, 'privateMessages');

    const authMessageArea = document.getElementById('auth-message-area');
    const signupBtn = document.getElementById('signupBtn');
    const loginBtn = document.getElementById('loginBtn');
    const uploadPostBtn = document.getElementById('uploadPostBtn');
    const postImageInput = document.getElementById('postImage');
    const postMessageArea = document.getElementById('post-message-area');
    const postsScroll = document.getElementById('posts-scroll-container');
    const noPostsMessage = document.getElementById('no-posts-message');
    const addChatEmailInput = document.getElementById('addChatEmail');
    const addChatBtn = document.getElementById('addChatBtn');
    const chatMessageArea = document.getElementById('chat-message-area');
    const chatListContainer = document.getElementById('chat-list-container');
    const noChatsMessage = document.getElementById('no-chats-message');
    const individualChatContainer = document.getElementById('individual-chat-container');
    const chatMessagesContainer = document.getElementById('chat-messages');
    const chatMessageInput = document.getElementById('chatMessageInput');
    const sendChatMessageBtn = document.getElementById('sendChatMessageBtn');
    const backToChatListBtn = document.getElementById('backToChatListBtn');
    const currentChatName = document.getElementById('current-chat-name');
    const currentChatAvatar = document.getElementById('current-chat-avatar');

    let currentChatId=null,currentChatRecipientUid=null,currentChatRecipientEmail=null;
    let postsListenerAttached = false;

    function displayMessage(area,msg,type='info'){area.innerHTML=`<div class="message ${type}">${msg}</div>`;setTimeout(()=>area.innerHTML='',4000);}
    async function createUserProfile(user){if(user)await set(ref(db,'users/'+user.uid),{email:user.email,uid:user.uid});}

    async function getUserByEmail(email){
      const q=query(usersRef,orderByChild('email'),equalTo(email));
      const s=await get(q);if(s.exists()){let u=null;s.forEach(c=>u=c.val());return u;}return null;
    }

    signupBtn.onclick=async()=>{const e=document.getElementById('email').value.trim(),p=document.getElementById('password').value.trim();
      if(!e||!p)return displayMessage(authMessageArea,'Email/password required','error');
      signupBtn.disabled=true;
      try{const c=await createUserWithEmailAndPassword(auth,e,p);await createUserProfile(c.user);
        document.getElementById('auth-section').style.display='none';document.getElementById('app-section').style.display='block';loadPosts();loadChatList();}
      catch(err){displayMessage(authMessageArea,'Sign up failed: '+err.message,'error');}
      finally{signupBtn.disabled=false;}
    };

    loginBtn.onclick=async()=>{const e=document.getElementById('email').value.trim(),p=document.getElementById('password').value.trim();
      if(!e||!p)return displayMessage(authMessageArea,'Email/password required','error');
      loginBtn.disabled=true;
      try{const c=await signInWithEmailAndPassword(auth,e,p);await createUserProfile(c.user);
        document.getElementById('auth-section').style.display='none';document.getElementById('app-section').style.display='block';loadPosts();loadChatList();}
      catch(err){displayMessage(authMessageArea,'Sign in failed: '+err.message,'error');}
      finally{loginBtn.disabled=false;}
    };

    onAuthStateChanged(auth,async(u)=>{if(u){await createUserProfile(u);document.getElementById('auth-section').style.display='none';document.getElementById('app-section').style.display='block';displayMessage(authMessageArea,`Welcome, ${u.email}`,'success');loadPosts();loadChatList();}
    else{document.getElementById('auth-section').style.display='block';document.getElementById('app-section').style.display='none';individualChatContainer.style.display='none';}});

    function fileToBase64(f){return new Promise((r,j)=>{const x=new FileReader();x.onload=()=>{const s=x.result;const p=s.split(',');r(p[p.length-1]);};x.onerror=j;x.readAsDataURL(f);});}
    async function uploadToImgBB_viaBase64(f){const b=await fileToBase64(f);const fd=new URLSearchParams();fd.append('key',IMGBB_API_KEY);fd.append('image',b);
      const r=await fetch('https://api.imgbb.com/1/upload',{method:'POST',body:fd});const j=await r.json();if(!j.success)throw new Error(j.error.message||'Upload fail');return j.data.url;}

    uploadPostBtn.onclick=async()=>{
      const f=postImageInput.files[0];if(!f)return displayMessage(postMessageArea,'Select image','error');
      if(!auth.currentUser)return displayMessage(postMessageArea,'Login required','error');
      uploadPostBtn.disabled=true;
      try{
        const url=await uploadToImgBB_viaBase64(f);
        const newRef = await push(postsRef,{imageUrl:url,timestamp:Date.now(),userId:auth.currentUser.uid,userEmail:auth.currentUser.email});
        console.log('Pushed post key:', newRef ? newRef.key : '(no key)');
        displayMessage(postMessageArea,'Post uploaded successfully!','success');postImageInput.value='';
      }catch(e){console.error('Upload failed',e);displayMessage(postMessageArea,'Upload failed: '+(e.message||e),'error');}finally{uploadPostBtn.disabled=false;}
    };

    function loadPosts(){
      if(postsListenerAttached) return;
      postsListenerAttached = true;
      onValue(postsRef,s=>{
        console.log('posts snapshot, exists=', s.exists(), 'numChildren=', s.numChildren ? s.numChildren() : null);
        postsScroll.innerHTML='';
        if(!s.exists()){ noPostsMessage.style.display='block'; return; }
        noPostsMessage.style.display='none';
        const arr=[];s.forEach(c=>arr.push({ key:c.key, ...c.val() }));
        arr.sort((a,b)=>(b.timestamp||0)-(a.timestamp||0));
        arr.forEach(p=>{
          const d=document.createElement('div'); d.className='post-card';
          const img = document.createElement('img');
          img.src = p.imageUrl;
          img.loading = 'lazy';
          img.alt = 'post';
          img.onerror = ()=>{ console.warn('Image failed to load:', p.imageUrl); d.innerHTML = '<div style="padding:8px;color:#666;font-size:13px">Image not available</div>'; };
          d.appendChild(img);
          postsScroll.appendChild(d);
        });
        // ensure the container is scannable on mobile
        postsScroll.style.display = 'flex';
      });
    }

    addChatBtn.onclick=async()=>{const e=addChatEmailInput.value.trim(),u=auth.currentUser;if(!u)return displayMessage(chatMessageArea,'Login first','error');
      if(!e)return displayMessage(chatMessageArea,'Enter email','error');if(e===u.email)return displayMessage(chatMessageArea,'Cannot chat with yourself','error');
      addChatBtn.disabled=true;
      try{const r=await getUserByEmail(e);if(!r)return displayMessage(chatMessageArea,'User not found','error');
        const ids=[u.uid,r.uid].sort();const id=ids.join('_');const ex = await get(ref(db, 'chats/' + id));
        if(ex.exists()){ displayMessage(chatMessageArea,'Chat already exists','info'); }
        else{ await set(ref(db,'chats/'+id),{members:ids,memberEmails:{[u.uid]:u.email,[r.uid]:r.email},createdAt:Date.now()}); displayMessage(chatMessageArea,'Chat added','success'); }
        addChatEmailInput.value='';
      }catch(er){console.error('Add chat error',er);displayMessage(chatMessageArea,'Failed to add person: '+(er.message||er),'error');}finally{addChatBtn.disabled=false;}
    };

    function loadChatList(){ const uid = auth.currentUser?.uid; if(!uid) return;
      chatListContainer.innerHTML=''; noChatsMessage.style.display='block';
      onValue(chatsRef,s=>{ chatListContainer.innerHTML=''; let found=false; s.forEach(c=>{ const v=c.val(); const k=c.key; if(v.members && v.members.includes(uid)){ found=true; const other = v.members.find(x=>x!==uid); const email = v.memberEmails ? v.memberEmails[other] : ''; const name = email ? email.split('@')[0] : 'Unknown'; const div=document.createElement('div'); div.className='chat-list-item'; div.innerHTML=`<div class='chat-list-avatar'>${name.charAt(0).toUpperCase()}</div><div><div style='font-weight:700'>${name}</div><div style='font-size:12px;color:#666'>${email}</div></div>`; div.onclick=()=>openIndividualChat(k, other, email); chatListContainer.appendChild(div); } }); noChatsMessage.style.display = found ? 'none' : 'block'; }); }

    function openIndividualChat(chatId, recipientUid, recipientEmail){ currentChatId=chatId; currentChatRecipientUid=recipientUid; currentChatRecipientEmail=recipientEmail;
      document.getElementById('chat-list-container').style.display='none'; document.getElementById('chat-management-area').style.display='none'; noChatsMessage.style.display='none'; individualChatContainer.style.display='flex';
      currentChatName.textContent = recipientEmail ? recipientEmail.split('@')[0] : 'Unknown'; currentChatAvatar.textContent = currentChatName.textContent.charAt(0).toUpperCase();
      chatMessagesContainer.innerHTML = ''; loadMessages(chatId);
    }

    function loadMessages(chatId){ chatMessagesContainer.innerHTML=''; const q = query(ref(db, 'privateMessages/' + chatId), orderByChild('timestamp')); onChildAdded(q, s=>{ const m = s.val(); const el = document.createElement('div'); el.className = 'chat-message ' + (m.senderUid === auth.currentUser?.uid ? 'sent' : 'received'); const senderName = m.senderEmail ? m.senderEmail.split('@')[0] : 'Unknown'; const time = m.timestamp ? new Date(m.timestamp).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' }) : ''; el.innerHTML = `${m.text || ''}<div style='font-size:11px;margin-top:6px;color:rgba(0,0,0,0.5)'>${senderName} • ${time}</div>`; chatMessagesContainer.appendChild(el); chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; }); }

    sendChatMessageBtn.onclick=async()=>{ const text=chatMessageInput.value.trim(); if(!text || !currentChatId || !auth.currentUser) return; sendChatMessageBtn.disabled=true; try{ await push(ref(db, 'privateMessages/' + currentChatId), { text, senderUid: auth.currentUser.uid, senderEmail: auth.currentUser.email, timestamp: Date.now() }); chatMessageInput.value=''; }catch(e){console.error('send error',e);displayMessage(chatMessageArea,'Failed to send message','error'); } finally{ sendChatMessageBtn.disabled=false; } }

    backToChatListBtn.onclick=()=>{ individualChatContainer.style.display='none'; document.getElementById('chat-list-container').style.display='block'; document.getElementById('chat-management-area').style.display='block'; noChatsMessage.style.display='block'; loadChatList(); }

  </script>
</body>
</html>

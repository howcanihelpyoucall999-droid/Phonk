<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Messaging App — ImgBB Debug Upload</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#f5f5f5;min-height:100vh;display:flex;justify-content:center;align-items:flex-start}
    .container{width:100%;max-width:520px;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.08);box-sizing:border-box;margin:12px}
    h2{text-align:center;margin:6px 0 12px}
    input,button{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
    button{background:#007bff;color:#fff;border:none;cursor:pointer;font-weight:600}
    button:disabled{background:#ccc;cursor:not-allowed}
    .message{padding:8px;border-radius:6px;margin:8px 0}
    .success{background:#e6ffef;color:#0b6623;border:1px solid #c9f3d6}
    .error{background:#ffecec;color:#8b1a1a;border:1px solid #f5c6c6}
    .debug{font-family:monospace;background:#f3f3f3;padding:8px;border-radius:6px;max-height:160px;overflow:auto;border:1px solid #e0e0e0;margin-top:8px}
    .small{font-size:0.9rem;color:#555}
  </style>
</head>
<body>
  <div class="container">
    <h2>Live Messaging App — ImgBB Upload Debug</h2>

    <div id="auth-section">
      <div id="auth-message-area"></div>
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <button id="signupBtn">Sign Up</button>
      <button id="loginBtn">Sign In</button>
    </div>

    <div id="app-section" style="display:none">
      <h3>Upload Post (ImgBB)</h3>
      <input id="postImage" type="file" accept="image/*"/>
      <button id="uploadPostBtn">Upload to ImgBB</button>
      <div id="post-message-area"></div>

      <div class="small">Debug logs (shows raw responses & network hints):</div>
      <div id="debugLog" class="debug"></div>

      <h3 style="margin-top:16px">Posts</h3>
      <div id="no-posts-message">No posts yet.</div>
      <div id="posts-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    // ----- CONFIG -----
    const firebaseConfig = {
      apiKey: "AIzaSyBUH95hXYxMVCfhJglN4j3CReXy-CLYwmA",
      authDomain: "live-messageinggkkh.firebaseapp.com",
      databaseURL: "https://live-messageinggkkh-default-rtdb.firebaseio.com",
      projectId: "live-messageinggkkh",
      storageBucket: "live-messageinggkkh.appspot.com",
      messagingSenderId: "537475612761",
      appId: "1:537475612761:web:d00723c117383e54027148"
    };

    // ImgBB API key (you provided)
    const IMGBB_API_KEY = "dd99dd6508ecaf9c5a78e1d20a234937";

    // ----- INIT -----
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ----- ELEMENTS -----
    const signupBtn = document.getElementById('signupBtn');
    const loginBtn = document.getElementById('loginBtn');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const uploadPostBtn = document.getElementById('uploadPostBtn');
    const postImageInput = document.getElementById('postImage');
    const postMessageArea = document.getElementById('post-message-area');
    const authMessageArea = document.getElementById('auth-message-area');
    const debugLog = document.getElementById('debugLog');
    const postsGrid = document.getElementById('posts-grid');
    const noPostsMessage = document.getElementById('no-posts-message');

    function logDebug(...args) {
      console.log(...args);
      try {
        const s = args.map(a => (typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a))).join(' ');
        debugLog.textContent = (debugLog.textContent ? debugLog.textContent + "\n\n" : '') + s;
        debugLog.scrollTop = debugLog.scrollHeight;
      } catch (e) { /* ignore */ }
    }

    function showMessage(area, text, type='info') {
      area.innerHTML = '<div class="message ' + (type === 'error' ? 'error' : (type === 'success' ? 'success' : '')) + '">' + text + '</div>';
    }

    // create user profile record in /users
    async function createUserProfile(user) {
      if (!user || !user.uid) return;
      await set(ref(db, `users/${user.uid}`), { uid: user.uid, email: user.email || null });
    }

    signupBtn.onclick = async () => {
      const email = String(emailInput.value || '').trim();
      const password = String(passwordInput.value || '').trim();
      if (!email || !password) { showMessage(authMessageArea, 'Email & password required', 'error'); return; }
      signupBtn.disabled = true;
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await createUserProfile(cred.user);
        showMessage(authMessageArea, 'Signed up', 'success');
      } catch (err) {
        console.error('signup error', err);
        showMessage(authMessageArea, 'Sign up failed: ' + err.message, 'error');
      } finally { signupBtn.disabled = false; }
    };

    loginBtn.onclick = async () => {
      const email = String(emailInput.value || '').trim();
      const password = String(passwordInput.value || '').trim();
      if (!email || !password) { showMessage(authMessageArea, 'Email & password required', 'error'); return; }
      loginBtn.disabled = true;
      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        await createUserProfile(cred.user);
        showMessage(authMessageArea, 'Signed in', 'success');
      } catch (err) {
        console.error('login error', err);
        showMessage(authMessageArea, 'Sign in failed: ' + err.message, 'error');
      } finally { loginBtn.disabled = false; }
    };

    // Auth state
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        document.getElementById('auth-section').style.display = 'none';
        document.getElementById('app-section').style.display = 'block';
        showMessage(authMessageArea, 'Welcome ' + user.email, 'success');
        startListeningPosts();
      } else {
        document.getElementById('auth-section').style.display = 'block';
        document.getElementById('app-section').style.display = 'none';
      }
    });

    // Listen to posts
    function startListeningPosts() {
      const postsRef = ref(db, 'posts');
      onValue(postsRef, snap => {
        postsGrid.innerHTML = '';
        if (!snap.exists()) {
          noPostsMessage.style.display = 'block';
          return;
        }
        noPostsMessage.style.display = 'none';
        const arr = [];
        snap.forEach(child => arr.push({ key: child.key, ...child.val() }));
        arr.sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
        for (const p of arr) {
          const div = document.createElement('div');
          div.style.borderRadius = '8px';
          div.style.overflow = 'hidden';
          div.innerHTML = `<img src="${p.imageUrl}" style="width:100%;display:block" alt="post"/>`;
          postsGrid.appendChild(div);
        }
      });
    }

    // Helpers to upload: try base64 + fallback to multipart if needed
    async function fileToBase64(file) {
      return await new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => {
          const result = r.result;
          if (typeof result === 'string') {
            // data:[<mediatype>][;base64],<data>
            const parts = result.split(',');
            res(parts.length > 1 ? parts[1] : parts[0]);
          } else res('');
        };
        r.onerror = rej;
        r.readAsDataURL(file);
      });
    }

    async function uploadToImgBB_viaBase64(file) {
      const base64 = await fileToBase64(file);
      logDebug('Attempting ImgBB upload via base64 (size bytes):', base64.length);
      const payload = new URLSearchParams();
      payload.append('key', IMGBB_API_KEY);
      payload.append('image', base64);
      // optional: name, expiration
      const res = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: payload });
      const text = await res.text();
      logDebug('ImgBB base64 raw response status:', res.status, 'text:', text);
      let json;
      try { json = JSON.parse(text); } catch(e) { throw new Error('ImgBB returned non-JSON: ' + text); }
      if (!json.success) throw new Error('ImgBB error: ' + (json.error && json.error.message ? json.error.message : JSON.stringify(json)));
      return json.data.url;
    }

    async function uploadToImgBB_viaForm(file) {
      const fd = new FormData();
      fd.append('image', file);
      fd.append('key', IMGBB_API_KEY);
      logDebug('Attempting ImgBB upload via multipart/form-data');
      const res = await fetch('https://api.imgbb.com/1/upload?key=' + IMGBB_API_KEY, { method: 'POST', body: fd });
      const text = await res.text();
      logDebug('ImgBB multipart raw response status:', res.status, 'text:', text);
      let json;
      try { json = JSON.parse(text); } catch(e) { throw new Error('ImgBB returned non-JSON: ' + text); }
      if (!json.success) throw new Error('ImgBB error: ' + (json.error && json.error.message ? json.error.message : JSON.stringify(json)));
      return json.data.url;
    }

    // Main upload handler (tries base64 first because it's reliable)
    uploadPostBtn.onclick = async () => {
      const file = postImageInput.files[0];
      if (!file) { showMessage(postMessageArea, 'Select an image file first', 'error'); return; }
      if (!auth.currentUser) { showMessage(postMessageArea, 'You must be logged in', 'error'); return; }
      uploadPostBtn.disabled = true;
      debugLog.textContent = ''; // clear debug
      try {
        let imageUrl;
        try {
          // try base64 approach first
          imageUrl = await uploadToImgBB_viaBase64(file);
          logDebug('ImgBB upload succeeded (base64):', imageUrl);
        } catch (errBase64) {
          logDebug('Base64 upload failed:', errBase64 && errBase64.message ? errBase64.message : errBase64);
          // try multipart as fallback
          imageUrl = await uploadToImgBB_viaForm(file);
          logDebug('ImgBB upload succeeded (form):', imageUrl);
        }

        // Save to Firebase posts
        await push(ref(db, 'posts'), {
          imageUrl,
          timestamp: Date.now(),
          userId: auth.currentUser.uid,
          userEmail: auth.currentUser.email
        });
        showMessage(postMessageArea, 'Post uploaded successfully!', 'success');
      } catch (err) {
        console.error('Final upload error:', err);
        showMessage(postMessageArea, 'Upload failed: ' + (err && err.message ? err.message : String(err)), 'error');
        logDebug('Final error object:', err);
        // Helpful hints:
        if (String(err).toLowerCase().includes('api key') || String(err).toLowerCase().includes('invalid')) {
          logDebug('Hint: Check the ImgBB API key is correct and active.');
        }
        if (String(err).toLowerCase().includes('cors') || String(err).toLowerCase().includes('access-control')) {
          logDebug('Hint: CORS error — try testing from a desktop browser with DevTools open. ImgBB should allow client uploads but some networks block cross-origin requests.');
        }
      } finally {
        uploadPostBtn.disabled = false;
      }
    };
  </script>
</body>
</html>

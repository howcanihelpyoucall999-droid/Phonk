<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Messaging App</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#f5f5f5;min-height:100vh;display:flex;justify-content:center;align-items:flex-start}
    .container{width:100%;max-width:520px;background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.08);box-sizing:border-box;margin:12px}
    h2{text-align:center;margin:6px 0 12px}
    h3{margin:14px 0 8px}
    input,button,textarea{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;font-size:15px}
    button{background:#007bff;color:#fff;border:none;cursor:pointer;font-weight:600}
    button:disabled{background:#ccc;cursor:not-allowed}
    .message{padding:8px;border-radius:6px;margin:8px 0}
    .success{background:#e6ffef;color:#0b6623;border:1px solid #c9f3d6}
    .error{background:#ffecec;color:#8b1a1a;border:1px solid #f5c6c6}
    .info{background:#eef6ff;color:#0b3a66;border:1px solid #cfe6ff}
    #posts-grid-container{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:8px}
    .post-card img{width:100%;display:block;border-radius:8px}
    .chat-list-item{display:flex;align-items:center;padding:10px;background:#f0f2f5;margin:6px 0;border-radius:8px;cursor:pointer}
    .chat-list-avatar{width:40px;height:40px;border-radius:50%;background:#007bff;color:#fff;display:flex;align-items:center;justify-content:center;margin-right:10px;font-weight:700}
    #individual-chat-container{display:none;flex-direction:column;border:1px solid #eee;padding:10px;border-radius:8px;margin-top:8px;background:#fafafa;height:60vh;min-height:360px}
    #chat-messages{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:6px;padding-right:6px}
    .chat-message{padding:8px 12px;border-radius:14px;max-width:78%;line-height:1.4;word-wrap:break-word}
    .chat-message.sent{background:#007bff;color:#fff;align-self:flex-end;margin-left:auto}
    .chat-message.received{background:#e8eaf0;color:#111;align-self:flex-start;margin-right:auto}
    #chat-input-area{display:flex;gap:8px;margin-top:8px}
    #chat-input-area input{flex:1;margin:0}
    @media(max-width:420px){#posts-grid-container{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h2>Live Messaging App</h2>

    <div id="auth-section">
      <div id="auth-message-area"></div>
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <button id="signupBtn">Sign Up</button>
      <button id="loginBtn">Sign In</button>
    </div>

    <div id="app-section" style="display:none">
      <h3>Upload Post</h3>
      <input id="postImage" type="file" accept="image/*" />
      <button id="uploadPostBtn">Upload</button>
      <div id="post-message-area"></div>

      <h3>Posts</h3>
      <div id="no-posts-message">No posts yet.</div>
      <div id="posts-grid-container"></div>

      <hr>

      <h3>My Chats</h3>
      <div id="chat-management-area">
        <div id="chat-message-area"></div>
        <input id="addChatEmail" type="email" placeholder="Enter user's email to chat" />
        <button id="addChatBtn">Add Person to Chat</button>
      </div>

      <div id="no-chats-message">No active chats. Add someone to start chatting!</div>
      <div id="chat-list-container"></div>

      <div id="individual-chat-container">
        <div id="chat-header" style="display:flex;align-items:center;gap:8px;padding-bottom:8px;border-bottom:1px solid #eee;margin-bottom:8px">
          <button id="backToChatListBtn" style="padding:6px 10px">&lt; Back</button>
          <div id="current-chat-avatar" class="chat-list-avatar"></div>
          <h4 id="current-chat-name" style="margin:0"></h4>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input-area">
          <input id="chatMessageInput" type="text" placeholder="Type a message..." />
          <button id="sendChatMessageBtn">Send</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { getDatabase, ref, push, onValue, set, query, orderByChild, equalTo, get, onChildAdded } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    // Firebase config (keep as yours)
    const firebaseConfig = {
      apiKey: "AIzaSyBUH95hXYxMVCfhJglN4j3CReXy-CLYwmA",
      authDomain: "live-messageinggkkh.firebaseapp.com",
      databaseURL: "https://live-messageinggkkh-default-rtdb.firebaseio.com",
      projectId: "live-messageinggkkh",
      storageBucket: "live-messageinggkkh.appspot.com",
      messagingSenderId: "537475612761",
      appId: "1:537475612761:web:d00723c117383e54027148"
    };

    // ImgBB API key (user provided)
    const IMGBB_API_KEY = "dd99dd6508ecaf9c5a78e1d20a234937";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // refs
    const postsRef = ref(db, 'posts');
    const usersRef = ref(db, 'users');
    const chatsRef = ref(db, 'chats');
    const privateMessagesRoot = ref(db, 'privateMessages');

    // elements
    const authMessageArea = document.getElementById('auth-message-area');
    const signupBtn = document.getElementById('signupBtn');
    const loginBtn = document.getElementById('loginBtn');
    const uploadPostBtn = document.getElementById('uploadPostBtn');
    const postImageInput = document.getElementById('postImage');
    const postMessageArea = document.getElementById('post-message-area');
    const postsGrid = document.getElementById('posts-grid-container');
    const noPostsMessage = document.getElementById('no-posts-message');
    const addChatEmailInput = document.getElementById('addChatEmail');
    const addChatBtn = document.getElementById('addChatBtn');
    const chatMessageArea = document.getElementById('chat-message-area');
    const chatListContainer = document.getElementById('chat-list-container');
    const noChatsMessage = document.getElementById('no-chats-message');
    const individualChatContainer = document.getElementById('individual-chat-container');
    const chatMessagesContainer = document.getElementById('chat-messages');
    const chatMessageInput = document.getElementById('chatMessageInput');
    const sendChatMessageBtn = document.getElementById('sendChatMessageBtn');
    const backToChatListBtn = document.getElementById('backToChatListBtn');
    const currentChatName = document.getElementById('current-chat-name');
    const currentChatAvatar = document.getElementById('current-chat-avatar');

    let currentChatId = null;
    let currentChatRecipientUid = null;
    let currentChatRecipientEmail = null;

    function displayMessage(area, message, type='info') {
      area.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(()=>{ area.innerHTML=''; }, 4500);
    }

    async function createUserProfile(user) {
      if (!user || !user.uid) return;
      await set(ref(db, `users/${user.uid}`), { email: user.email || null, uid: user.uid });
    }

    async function getUserByEmail(email) {
      if (!email) return null;
      const usersQuery = query(usersRef, orderByChild('email'), equalTo(email));
      const snapshot = await get(usersQuery);
      if (snapshot.exists()) {
        let profile = null;
        snapshot.forEach(child => profile = child.val());
        return profile;
      }
      return null;
    }

    // signup/login
    signupBtn.onclick = async ()=>{
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!email || !password) { displayMessage(authMessageArea,'Email and password required','error'); return; }
      signupBtn.disabled = true;
      try {
        const cred = await createUserWithEmailAndPassword(auth,email,password);
        await createUserProfile(cred.user);
        displayMessage(authMessageArea,'Signed up','success');
        document.getElementById('auth-section').style.display='none';
        document.getElementById('app-section').style.display='block';
        loadPosts(); loadChatList();
      } catch(err){ displayMessage(authMessageArea, 'Sign up failed: '+err.message,'error'); }
      finally{ signupBtn.disabled=false; }
    };

    loginBtn.onclick = async ()=>{
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      if (!email || !password) { displayMessage(authMessageArea,'Email and password required','error'); return; }
      loginBtn.disabled = true;
      try{
        const cred = await signInWithEmailAndPassword(auth,email,password);
        const user = auth.currentUser;
        if (user) {
          const userSnap = await get(ref(db, `users/${user.uid}`));
          if (!userSnap.exists()) await createUserProfile(user);
        }
        displayMessage(authMessageArea,'Signed in','success');
        document.getElementById('auth-section').style.display='none';
        document.getElementById('app-section').style.display='block';
        loadPosts(); loadChatList();
      }catch(err){
        displayMessage(authMessageArea,'Sign in failed: '+err.message,'error');
      }finally{ loginBtn.disabled=false; }
    };

    onAuthStateChanged(auth, async (user)=>{
      if (user) {
        await createUserProfile(user);
        document.getElementById('auth-section').style.display='none';
        document.getElementById('app-section').style.display='block';
        displayMessage(authMessageArea, `Welcome, ${user.email}`,'success');
        loadPosts(); loadChatList();
      } else {
        document.getElementById('auth-section').style.display='block';
        document.getElementById('app-section').style.display='none';
        individualChatContainer.style.display='none';
      }
    });

    // posts
    function loadPosts(){
      postsGrid.innerHTML='';
      onValue(postsRef, snapshot=>{
        postsGrid.innerHTML='';
        if (!snapshot.exists()) { noPostsMessage.style.display='block'; return; }
        noPostsMessage.style.display='none';
        const arr=[];
        snapshot.forEach(child=>arr.push({ key: child.key, ...child.val() }));
        arr.sort((a,b)=> (b.timestamp||0)-(a.timestamp||0));
        arr.forEach(post=>{
          const d=document.createElement('div'); d.className='post-card';
          d.innerHTML=`<img src="${post.imageUrl}" alt="post" />`;
          postsGrid.appendChild(d);
        });
      });
    }

    // ImgBB helpers
    function fileToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>{ const s=r.result; if(typeof s==='string'){ const parts=s.split(','); res(parts.length>1?parts[1]:parts[0]); }else res(''); }; r.onerror=rej; r.readAsDataURL(file); }); }

    async function uploadToImgBB_viaBase64(file){
      const base64 = await fileToBase64(file);
      const payload = new URLSearchParams();
      payload.append('key', IMGBB_API_KEY);
      payload.append('image', base64);
      const res = await fetch('https://api.imgbb.com/1/upload', { method:'POST', body: payload });
      const json = await res.json();
      if (!json.success) throw new Error(json.error && json.error.message ? json.error.message : 'ImgBB base64 upload failed');
      return json.data.url;
    }

    async function uploadToImgBB_viaForm(file){
      const fd=new FormData();
      fd.append('image', file);
      fd.append('key', IMGBB_API_KEY);
      const res = await fetch('https://api.imgbb.com/1/upload?key='+IMGBB_API_KEY, { method:'POST', body: fd });
      const json = await res.json();
      if (!json.success) throw new Error(json.error && json.error.message ? json.error.message : 'ImgBB form upload failed');
      return json.data.url;
    }

    uploadPostBtn.onclick = async ()=>{
      const file = postImageInput.files[0];
      if (!file) return displayMessage(postMessageArea,'Select an image file first','error');
      if (!auth.currentUser) return displayMessage(postMessageArea,'You must be logged in','error');
      uploadPostBtn.disabled=true;
      try{
        let imageUrl;
        try{ imageUrl = await uploadToImgBB_viaBase64(file); } catch(e){ console.warn('base64 failed',e); imageUrl = await uploadToImgBB_viaForm(file); }
        await push(postsRef, { imageUrl, timestamp: Date.now(), userId: auth.currentUser.uid, userEmail: auth.currentUser.email });
        displayMessage(postMessageArea,'Post uploaded successfully!','success');
        postImageInput.value='';
      }catch(err){
        console.error('Upload failed',err);
        displayMessage(postMessageArea,'Upload failed: '+(err.message||err),'error');
      }finally{ uploadPostBtn.disabled=false; }
    };

    // add chat
    addChatBtn.onclick = async ()=>{
      const recipientEmail = addChatEmailInput.value.trim();
      const currentUser = auth.currentUser;
      if (!currentUser) return displayMessage(chatMessageArea,'You must be logged in to add a person','error');
      if (!recipientEmail) return displayMessage(chatMessageArea,'Please enter an email address','error');
      if (recipientEmail === currentUser.email) return displayMessage(chatMessageArea,"You cannot add yourself to a chat",'error');
      addChatBtn.disabled=true;
      try{
        const recipientProfile = await getUserByEmail(recipientEmail);
        if (!recipientProfile || !recipientProfile.uid || !recipientProfile.email) {
          displayMessage(chatMessageArea, `No user found with email: ${recipientEmail}`, 'error');
          console.error('Invalid recipient profile:', recipientProfile);
          return;
        }
        const recipientUid = recipientProfile.uid, currentUid = currentUser.uid;
        const chatMembers = [currentUid, recipientUid].sort();
        const chatId = chatMembers.join('_');
        const existing = await get(ref(db, `chats/${chatId}`));
        if (existing.exists()) { displayMessage(chatMessageArea, 'Chat already exists','info'); }
        else {
          await set(ref(db, `chats/${chatId}`), { members: chatMembers, memberEmails: { [currentUid]: currentUser.email, [recipientUid]: recipientProfile.email }, createdAt: Date.now() });
          displayMessage(chatMessageArea, 'Chat added successfully!','success');
        }
        addChatEmailInput.value='';
      }catch(err){ console.error('Add chat error',err); displayMessage(chatMessageArea,'Failed to add person: '+(err.message||err),'error'); }
      finally{ addChatBtn.disabled=false; }
    };

    function loadChatList(){
      if (!auth.currentUser) return;
      chatListContainer.innerHTML='';
      noChatsMessage.style.display='block';
      const userUid = auth.currentUser.uid;
      onValue(chatsRef, snapshot=>{
        chatListContainer.innerHTML='';
        let found=false;
        snapshot.forEach(child=>{
          const chat = child.val(); const chatId = child.key;
          if (chat.members && chat.members.includes(userUid)) {
            found=true;
            const otherUid = chat.members.find(u=>u!==userUid);
            const otherEmail = chat.memberEmails ? chat.memberEmails[otherUid] : null;
            const name = otherEmail ? otherEmail.split('@')[0] : 'Unknown';
            const div=document.createElement('div'); div.className='chat-list-item';
            div.innerHTML=`<div class="chat-list-avatar">${name.charAt(0).toUpperCase()}</div><div><div style="font-weight:700">${name}</div><div style="font-size:12px;color:#666">${otherEmail||''}</div></div>`;
            div.onclick = ()=> openIndividualChat(chatId, otherUid, otherEmail);
            chatListContainer.appendChild(div);
          }
        });
        noChatsMessage.style.display = found ? 'none' : 'block';
      });
    }

    function openIndividualChat(chatId, recipientUid, recipientEmail){
      currentChatId = chatId; currentChatRecipientUid = recipientUid; currentChatRecipientEmail = recipientEmail;
      document.getElementById('chat-list-container').style.display='none';
      document.getElementById('chat-management-area').style.display='none';
      noChatsMessage.style.display='none';
      individualChatContainer.style.display='flex';
      currentChatName.textContent = recipientEmail ? recipientEmail.split('@')[0] : 'Unknown';
      currentChatAvatar.textContent = currentChatName.textContent.charAt(0).toUpperCase();
      chatMessagesContainer.innerHTML='';
      loadMessages(chatId);
    }

    function loadMessages(chatId){
      chatMessagesContainer.innerHTML='';
      const q = query(ref(db, `privateMessages/${chatId}`), orderByChild('timestamp'));
      onChildAdded(q, snap=>{
        const msg = snap.val();
        const el = document.createElement('div'); el.className='chat-message ' + (msg.senderUid===auth.currentUser.uid ? 'sent' : 'received');
        const senderName = msg.senderEmail ? msg.senderEmail.split('@')[0] : 'Unknown';
        const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
        el.innerHTML = `${msg.text||''}<div style="font-size:11px;margin-top:6px;color:rgba(0,0,0,0.5)">${senderName} • ${time}</div>`;
        chatMessagesContainer.appendChild(el);
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
      });
    }

    sendChatMessageBtn.onclick = async ()=>{
      const text = chatMessageInput.value.trim();
      if (!text || !currentChatId || !auth.currentUser) return;
      sendChatMessageBtn.disabled=true;
      try{
        await push(ref(db, `privateMessages/${currentChatId}`), { text, senderUid: auth.currentUser.uid, senderEmail: auth.currentUser.email, timestamp: Date.now() });
        chatMessageInput.value='';
      }catch(err){ console.error('send error',err); displayMessage(chatMessageArea,'Failed to send message','error'); }
      finally{ sendChatMessageBtn.disabled=false; }
    };

    backToChatListBtn.onclick = ()=>{
      individualChatContainer.style.display='none';
      document.getElementById('chat-list-container').style.display='block';
      document.getElementById('chat-management-area').style.display='block';
      noChatsMessage.style.display='block';
      loadChatList();
    };

  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zag Messenger — Auth fixed</title>
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#eef6ff;
      --primary:#0b60d6;
      --primary-dark:#0849a6;
      --muted:#9aaecf;
      --accent:#2b81ff;
      --hand-font:'Patrick Hand', 'Segoe UI', Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:var(--hand-font);background:linear-gradient(180deg,var(--bg),#fff 70%);}
    .phone{width:100%;max-width:460px;margin:0 auto;height:100vh;background:#fff;display:flex;flex-direction:column;position:relative;overflow:hidden;}
    .header{display:flex;align-items:center;padding:10px 14px;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;gap:12px}
    .logo{width:36px;height:36px;border-radius:50%;background:#fff;color:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:700}
    .title{font-size:18px;font-weight:700}
    .menu{margin-left:auto;font-size:22px;opacity:0.95}
    .wave-top{height:20px;width:100%}
    .wave-top svg{width:100%;height:100%}
    .auth{flex:1;padding:18px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;background:transparent}
    input[type="text"], input[type="email"], input[type="tel"], input[type="password"]{
      width:92%;max-width:420px;padding:12px;border-radius:10px;border:1px solid rgba(11,96,214,0.08);background:linear-gradient(180deg,#fff,#fbfdff);font-size:15px;color:var(--primary)
    }
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700;font-size:15px}
    .primary{background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff}
    .ghost{background:#f6f9ff;color:var(--primary);border:1px solid rgba(11,96,214,0.06)}
    .small{font-size:13px;color:var(--muted)}
    .app{display:none;flex:1;padding:14px 16px 120px 16px;overflow:auto}
    h3.section-title{font-size:22px;color:var(--primary);margin:6px 0 14px}
    .card{background:linear-gradient(180deg,#fff,#fbfdff);border-radius:12px;padding:12px;border:1px solid rgba(11,96,214,0.06);margin-bottom:12px;display:flex;gap:12px;align-items:center}
    .avatar{width:56px;height:56px;border-radius:50%;background:linear-gradient(180deg,#dbeeff,#c1ddff);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);font-size:18px;flex-shrink:0}
    .meta{flex:1}
    .meta .name{font-weight:700;color:var(--primary);font-size:16px}
    .meta .sub{color:var(--muted);font-size:13px;margin-top:6px}
    .bottom-nav{position:fixed;left:0;right:0;bottom:0;height:68px;background:linear-gradient(180deg,#fff,#f6fbff);display:flex;align-items:center;justify-content:space-around;padding:8px 14px;border-top:1px solid rgba(0,0,0,0.03);z-index:60}
    .bottom-nav span{font-weight:700;color:var(--primary);padding:8px 14px;border-radius:10px;cursor:pointer}
    .bottom-nav .active{background:linear-gradient(180deg,#eff7ff,#dfeffe);box-shadow:0 8px 20px rgba(11,96,214,0.06)}
    .floating-new{position:fixed;right:20px;bottom:96px;z-index:80;width:64px;height:64px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff;font-size:30px;font-weight:700;box-shadow:0 20px 60px rgba(11,96,214,0.18);border:6px solid #fff;cursor:pointer;display:none}
    .plus-menu{position:fixed;right:20px;bottom:168px;width:210px;background:#fff;border-radius:12px;padding:8px;box-shadow:0 20px 60px rgba(0,0,0,0.12);display:none;flex-direction:column;gap:8px;z-index:85}
    .plus-menu button{padding:10px;border-radius:8px;border:1px solid rgba(11,96,214,0.06);background:#f6fbff;cursor:pointer;font-weight:700;color:var(--primary)}
    .chat-screen{display:none;flex-direction:column;flex:1;overflow:hidden}
    .chat-header{display:flex;gap:12px;align-items:center;padding:10px 14px;border-bottom:1px dashed rgba(11,96,214,0.04);background:#fff}
    #messages{flex:1;overflow:auto;padding:12px 14px 180px 14px;display:flex;flex-direction:column;gap:10px;background:transparent}
    .bubble{display:inline-block;padding:10px 14px;border-radius:18px;max-width:78%;line-height:1.35;box-shadow:0 6px 18px rgba(10,30,80,0.04);position:relative}
    .bubble.sent{align-self:flex-end;background:linear-gradient(180deg,var(--primary),var(--primary-dark));color:#fff}
    .bubble.received{align-self:flex-start;background:#fff;color:var(--primary);border:1px solid rgba(11,96,214,0.04)}
    .meta-row{display:flex;align-items:center;gap:8px}
    .sender-name{font-size:12px;color:var(--muted)}
    .time-pill{margin-left:auto;background:#e9f6ff;color:var(--primary);font-weight:700;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(11,96,214,0.06)}
    .chat-input-area-wrapper{position:fixed;left:0;right:0;bottom:64px;padding:12px 18px;background:linear-gradient(180deg,#fff,#f6fbff);z-index:70;box-shadow:0 -12px 30px rgba(11,96,214,0.04)}
    .chat-input{display:flex;gap:8px;align-items:center;background:#fff;border-radius:999px;padding:8px;border:2px solid rgba(11,96,214,0.12);max-width:920px;margin:0 auto}
    .chat-input input{flex:1;border:none;outline:none;padding:10px;font-size:15px}
    .send-btn{width:48px;height:48px;border-radius:50%;border:none;background:linear-gradient(180deg,var(--accent),#1f63d9);color:#fff;font-weight:700;cursor:pointer}
    .modal-backdrop{display:none;position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(0,0,0,0.35);align-items:center;justify-content:center;z-index:200}
    .modal{background:#fff;border-radius:12px;padding:14px;max-width:520px;width:92%;box-shadow:0 40px 120px rgba(0,0,0,0.25);max-height:90vh;overflow:auto}
    .contact-item{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;cursor:pointer}
    .contact-item:hover{background:#f6fbff}
    .profile{display:flex;flex-direction:column;gap:10px}
    .contacts-list{max-height:240px;overflow:auto;padding-top:6px}
    @media (max-width:420px){ .floating-new{right:12px;bottom:86px;width:56px;height:56px} .plus-menu{right:12px} }
  </style>
</head>
<body>
  <div class="phone">
    <div class="header">
      <div class="logo">Zg</div>
      <div class="title">Zag Messenger</div>
      <div class="menu">☰</div>
    </div>
    <div class="wave-top">
      <svg viewBox="0 0 100 10" preserveAspectRatio="none"><path d="M0 5 C20 9,40 1,60 5 C80 9,100 3,100 3 L100 10 L0 10 Z" fill="#0b60d6"></path></svg>
    </div>

    <!-- AUTH -->
    <div class="auth" id="auth-section">
      <div style="text-align:center">
        <div style="font-size:22px;font-weight:700;color:var(--primary)">Welcome to Zag Messenger</div>
        <div class="small" style="margin-top:6px">Sign up or sign in to continue</div>
      </div>
      <input id="email" type="email" placeholder="Email">
      <input id="phoneNumber" type="tel" placeholder="Phone number (without +880)">
      <input id="password" type="password" placeholder="Password">
      <button id="authSubmitBtn" class="btn primary">Sign Up</button>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="toSignIn" class="btn ghost">Sign In</button>
        <button id="toSignUp" class="btn ghost" style="display:none">Sign Up</button>
      </div>
    </div>

    <!-- APP -->
    <div class="app" id="app-section">
      <h3 class="section-title" id="list-title">My chats</h3>
      <div id="list-container"></div>
    </div>

    <!-- CHAT SCREEN -->
    <div class="chat-screen" id="chat-screen">
      <div class="chat-header">
        <button id="backToListBtn" class="btn ghost">&lt; Back</button>
        <div id="chat-header-meta">
          <div id="current-chat-name" style="font-weight:700;color:var(--primary)"></div>
          <div id="current-chat-sub" class="small"></div>
        </div>
      </div>
      <div id="messages"></div>

      <div class="chat-input-area-wrapper">
        <div class="chat-input">
          <input id="chatMessageInput" placeholder="Type a message...">
          <button id="sendChatMessageBtn" class="send-btn">➤</button>
        </div>
      </div>
    </div>

    <!-- floating + and menu (hidden when not signed in) -->
    <div class="floating-new" id="floatingNewBtn">+</div>
    <div class="plus-menu" id="plusMenu">
      <button id="plusIndividualBtn">New Private Chat</button>
      <button id="plusGroupBtn">Create Group</button>
    </div>

    <!-- group modal -->
    <div class="modal-backdrop" id="modalBackdrop">
      <div class="modal" role="dialog" aria-modal="true">
        <h3>Create Group</h3>
        <div style="margin:8px 0"><input id="groupName" placeholder="Group name"></div>
        <div style="margin:8px 0"><input id="addMemberInput" placeholder="Add member by email or phone and press Enter"></div>
        <div style="margin:8px 0"><strong>Selected members</strong>
          <div id="selectedMembers" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px"></div>
        </div>
        <div style="margin:8px 0"><strong>Contacts</strong>
          <div id="contactsList" class="contacts-list"></div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="cancelCreateGroup" class="btn ghost">Cancel</button>
          <button id="createGroupBtn" class="btn primary">Create Group</button>
        </div>
      </div>
    </div>

    <!-- profile section (displayed when @You nav clicked) -->
    <div id="profile-section" class="app" style="display:none">
      <h3 class="section-title">Your Profile</h3>
      <div class="profile">
        <div><input id="displayNameInput" placeholder="Display name"></div>
        <div><input id="profilePhone" placeholder="Phone number (without +880)"></div>
        <div style="display:flex;gap:8px"><button id="saveProfileBtn" class="btn primary">Save</button><button id="signOutBtn" class="btn ghost">Sign out</button></div>
        <h4 style="margin-top:12px">Your contacts</h4>
        <div id="myContacts" class="contacts-list"></div>
      </div>
    </div>

    <!-- bottom nav -->
    <div class="bottom-nav" id="bottomNav" style="display:none">
      <span id="nav-home" class="active">Home</span>
      <span id="nav-groups">Groups</span>
      <span id="nav-you">@You</span>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js';
    import { getDatabase, ref as dbRef, set, get, onValue, push, update } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js';

    // ---------- Firebase config ----------
    const firebaseConfig = {
      apiKey: 'AIzaSyBUH95hXYxMVCfhJglN4j3CReXy-CLYwmA',
      authDomain: 'live-messageinggkkh.firebaseapp.com',
      databaseURL: 'https://live-messageinggkkh-default-rtdb.firebaseio.com',
      projectId: 'live-messageinggkkh',
      storageBucket: 'live-messageinggkkh.appspot.com',
      messagingSenderId: '537475612761',
      appId: '1:537475612761:web:d00723c117383e54027148'
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // DOM refs
    const authSection = document.getElementById('auth-section');
    const appSection = document.getElementById('app-section');
    const profileSection = document.getElementById('profile-section');
    const listContainer = document.getElementById('list-container');
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const phoneEl = document.getElementById('phoneNumber');
    const authSubmitBtn = document.getElementById('authSubmitBtn');
    const toSignIn = document.getElementById('toSignIn');
    const toSignUp = document.getElementById('toSignUp');
    const floatingNewBtn = document.getElementById('floatingNewBtn');
    const plusMenu = document.getElementById('plusMenu');
    const plusIndividualBtn = document.getElementById('plusIndividualBtn');
    const plusGroupBtn = document.getElementById('plusGroupBtn');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const groupNameInput = document.getElementById('groupName');
    const addMemberInput = document.getElementById('addMemberInput');
    const contactsList = document.getElementById('contactsList');
    const selectedMembers = document.getElementById('selectedMembers');
    const createGroupBtn = document.getElementById('createGroupBtn');
    const cancelCreateGroup = document.getElementById('cancelCreateGroup');
    const navHome = document.getElementById('nav-home');
    const navGroups = document.getElementById('nav-groups');
    const navYou = document.getElementById('nav-you');
    const bottomNav = document.getElementById('bottomNav');
    const chatScreen = document.getElementById('chat-screen');
    const backToListBtn = document.getElementById('backToListBtn');
    const messagesEl = document.getElementById('messages');
    const currentChatNameEl = document.getElementById('current-chat-name');
    const currentChatSubEl = document.getElementById('current-chat-sub');
    const chatInput = document.getElementById('chatMessageInput');
    const sendChatBtn = document.getElementById('sendChatMessageBtn');
    const displayNameInput = document.getElementById('displayNameInput');
    const profilePhone = document.getElementById('profilePhone');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const myContactsEl = document.getElementById('myContacts');

    // state
    let currentUser = null;
    let usersCache = {};
    let selectedGroupMembersObj = {};
    let currentChat = null;
    let isSignUpMode = true;

    // helper: BD time
    function formatBDTime(ts){
      try{
        const dt = new Date(ts);
        const fmt = new Intl.DateTimeFormat('en-GB', { hour: '2-digit', minute: '2-digit', day:'2-digit', month:'short', timeZone: 'Asia/Dhaka' });
        return fmt.format(dt);
      }catch(e){
        const dt = new Date(ts);
        return dt.toLocaleTimeString();
      }
    }

    // --- UI initial state: hide nav and floating + until signed in
    bottomNav.style.display = 'none';
    floatingNewBtn.style.display = 'none';
    plusMenu.style.display = 'none';

    // toggle auth mode UI
    toSignIn.onclick = () => {
      isSignUpMode = false;
      authSubmitBtn.textContent = 'Sign In';
      toSignIn.style.display = 'none';
      toSignUp.style.display = 'inline-block';
    };
    toSignUp.onclick = () => {
      isSignUpMode = true;
      authSubmitBtn.textContent = 'Sign Up';
      toSignUp.style.display = 'none';
      toSignIn.style.display = 'inline-block';
    };

    // create user profile if missing
    async function createUserProfileIfMissing(user){
      if(!user) return;
      const uRef = dbRef(db, 'users/' + user.uid);
      const snap = await get(uRef);
      if(!snap.exists()){
        const displayName = user.email ? user.email.split('@')[0] : '';
        await set(uRef, {
          uid: user.uid,
          email: user.email || '',
          displayName,
          phoneNumber: phoneEl.value ? '+880' + phoneEl.value.trim() : ''
        });
      } else {
        // update missing fields if provided
        const data = snap.val();
        const updates = {};
        if(!data.displayName && user.email) updates.displayName = user.email.split('@')[0];
        if(!data.phoneNumber && phoneEl.value) updates.phoneNumber = '+880' + phoneEl.value.trim();
        if(Object.keys(updates).length) await update(uRef, updates);
      }
    }

    // Sign up / Sign in action
    authSubmitBtn.onclick = async () => {
      const email = (emailEl.value || '').trim();
      const pw = (passEl.value || '').trim();
      if(!email || !pw) return alert('Please enter email and password');
      try{
        if(isSignUpMode){
          const cred = await createUserWithEmailAndPassword(auth, email, pw);
          await createUserProfileIfMissing(cred.user);
          // onAuthStateChanged will handle navigation
        } else {
          await signInWithEmailAndPassword(auth, email, pw);
          // onAuthStateChanged will handle navigation
        }
      }catch(err){
        alert((isSignUpMode ? 'Sign up' : 'Sign in') + ' failed: ' + err.message);
        console.error(err);
      }
    };

    // users cache (names)
    function loadUsersCache(){
      const uRef = dbRef(db, 'users');
      onValue(uRef, snap => {
        usersCache = {};
        contactsList.innerHTML = '';
        myContactsEl && (myContactsEl.innerHTML = '');
        if(!snap.exists()) return;
        snap.forEach(s => {
          const u = s.val();
          if(!u || !u.uid) return;
          usersCache[u.uid] = u;
          if(currentUser && u.uid !== currentUser.uid){
            const row = document.createElement('div');
            row.className = 'contact-item';
            row.innerHTML = `<div class="avatar" style="width:40px;height:40px;font-size:14px">${(u.displayName||u.email||'U').charAt(0).toUpperCase()}</div>
                             <div style="flex:1"><div style="font-weight:700;color:var(--primary)">${u.displayName || u.email || u.phoneNumber}</div>
                             <div class="small">${u.phoneNumber || ''}</div></div>`;
            row.onclick = () => {
              if(selectedGroupMembersObj[u.uid]){ delete selectedGroupMembersObj[u.uid]; row.style.opacity='1' }
              else { selectedGroupMembersObj[u.uid] = u; row.style.opacity='0.6' }
              renderSelectedMembers();
            };
            contactsList.appendChild(row);
          }
        });
        renderMyContacts();
      });
    }

    function renderSelectedMembers(){
      selectedMembers.innerHTML = '';
      Object.values(selectedGroupMembersObj).forEach(u => {
        const span = document.createElement('div');
        span.style.padding = '6px 10px';
        span.style.background = '#f0f6ff';
        span.style.borderRadius = '999px';
        span.style.marginRight = '6px';
        span.style.display = 'inline-block';
        span.textContent = u.displayName || u.email || u.phoneNumber || 'Member';
        selectedMembers.appendChild(span);
      });
    }

    // add contact by identifier
    async function addContactByIdentifier(identifier){
      const usersRef = dbRef(db, 'users');
      const snap = await get(usersRef);
      let found = null;
      snap.forEach(s => {
        const u = s.val();
        if(!u) return;
        if(u.email === identifier || u.phoneNumber === identifier || (u.phoneNumber && u.phoneNumber.endsWith(identifier))) found = u;
      });
      if(!found) return alert('User not found (they must sign up first).');
      await set(dbRef(db, `contacts/${currentUser.uid}/${found.uid}`), true);
      alert('Added to your contacts. You can now chat with them.');
      await loadContactsAndLists();
      openPrivateChatWith(found);
    }

    // load contacts and lists
    async function loadContactsAndLists(){
      if(!currentUser) return;
      const cSnap = await get(dbRef(db, `contacts/${currentUser.uid}`));
      const contacts = cSnap.exists() ? Object.keys(cSnap.val()) : [];
      listContainer.innerHTML = '';
      const title = document.getElementById('list-title');
      if(navHome.classList.contains('active')) title.innerText = 'My chats';
      else if(navGroups.classList.contains('active')) title.innerText = 'Groups';

      if(navHome.classList.contains('active')){
 